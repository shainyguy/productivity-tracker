<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üöÄ Productivity Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg1: #1a1a2e; --bg2: #16213e; --bg3: #0f3460;
            --accent: #00d4ff; --accent2: #7b2cbf;
            --success: #00ff88; --warning: #ffd700; --danger: #ff4757;
            --text: #fff; --muted: #888; --card: rgba(255,255,255,0.05);
            --radius: 16px; --sidebar: 260px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* === LAYOUT === */
        .app { display: flex; min-height: 100vh; }

        /* === SIDEBAR (Desktop) === */
        .sidebar {
            width: var(--sidebar);
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            padding: 20px;
            display: none;
            flex-direction: column;
            position: fixed;
            left: 0; top: 0; bottom: 0;
            z-index: 100;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 30px;
            padding: 10px;
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-nav { flex: 1; }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: var(--muted);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            width: 100%;
            font-size: 1em;
            text-align: left;
        }

        .nav-link:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .nav-link.active { background: rgba(0,212,255,0.15); color: var(--accent); }
        .nav-link .icon { font-size: 1.3em; }

        .sidebar-footer {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            text-align: center;
        }

        .sidebar-xp { font-size: 1.5em; font-weight: bold; color: var(--accent); }
        .sidebar-level { color: var(--muted); font-size: 0.9em; }

        /* === MOBILE HEADER === */
        .mobile-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
        }

        .m-logo { font-size: 1.2em; font-weight: bold; background: linear-gradient(45deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .m-xp { background: linear-gradient(45deg, var(--accent), var(--accent2)); padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }

        /* === BOTTOM NAV (Mobile) === */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 65px;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bnav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            color: var(--muted);
            font-size: 0.7em;
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
        }

        .bnav-item.active { color: var(--accent); }
        .bnav-item .icon { font-size: 1.8em; }

        /* === MAIN CONTENT === */
        .main {
            flex: 1;
            padding: 70px 15px 80px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === CARDS === */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .card-title { font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        /* === GRIDS === */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

        /* === STATS === */
        .stat-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; text-align: center; }
        .stat-icon { font-size: 1.5em; margin-bottom: 5px; }
        .stat-value { font-size: 1.4em; font-weight: bold; color: var(--accent); }
        .stat-label { font-size: 0.75em; color: var(--muted); }

        /* === LEVEL === */
        .level-card { background: linear-gradient(135deg, rgba(123,44,191,0.2), rgba(0,212,255,0.2)); }
        .level-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .level-badge { font-weight: bold; }
        .xp-text { color: var(--warning); }
        .progress-bar { height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width 0.5s; }
        .rank { text-align: center; margin-top: 8px; color: var(--warning); font-size: 0.9em; }

        /* === BUTTONS === */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(45deg, var(--accent), var(--accent2)); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-sm { padding: 8px 14px; font-size: 0.85em; }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 10px; }

        .fab {
            position: fixed;
            bottom: 85px; right: 20px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            border: none;
            font-size: 1.5em;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,212,255,0.4);
            z-index: 99;
        }

        /* === INPUTS === */
        .input, .textarea, .select {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-size: 1em;
        }
        .input:focus, .textarea:focus { outline: none; border-color: var(--accent); }
        .textarea { min-height: 100px; resize: vertical; }
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; margin-bottom: 6px; font-size: 0.9em; color: var(--muted); }

        /* === HABITS === */
        .habit-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            gap: 12px;
            transition: all 0.3s;
        }
        .habit-item.done { background: rgba(0,255,136,0.1); }

        .habit-check {
            width: 26px; height: 26px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .habit-check.checked { background: var(--success); border-color: var(--success); }
        .habit-check.checked::after { content: '‚úì'; color: #000; font-weight: bold; }

        .habit-info { flex: 1; min-width: 0; }
        .habit-name { font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .habit-streak { font-size: 0.8em; color: var(--warning); }

        .habit-pct {
            background: rgba(0,212,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            color: var(--accent);
            font-weight: bold;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.5;
            padding: 5px;
        }
        .delete-btn:hover { opacity: 1; }

        /* === TASKS === */
        .task-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            gap: 10px;
        }
        .task-item.done { opacity: 0.5; }
        .task-item.done .task-text { text-decoration: line-through; }

        .task-check {
            width: 22px; height: 22px;
            border: 2px solid var(--accent);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .task-check.checked { background: var(--success); border-color: var(--success); }
        .task-check.checked::after { content: '‚úì'; color: #000; font-size: 0.8em; }

        .task-content { flex: 1; min-width: 0; }
        .task-text { font-size: 0.95em; margin-bottom: 6px; }

        .task-tags { display: flex; flex-wrap: wrap; gap: 5px; }

        .tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .priority-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
        .priority-high { background: var(--danger); }
        .priority-medium { background: var(--warning); }
        .priority-low { background: var(--success); }

        /* === TAGS === */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }

        .tag-btn {
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .tag-btn.selected { border-color: #fff; }
        .tag-btn:active { transform: scale(0.95); }

        .tag-colors { display: flex; gap: 8px; flex-wrap: wrap; }

        .color-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
        }
        .color-btn.selected { border-color: #fff; }

        /* === TABS === */
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }

        .tab {
            padding: 10px 16px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 10px;
            color: var(--muted);
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .tab.active { background: var(--accent); color: #000; }

        /* === CHARTS === */
        .chart-container { position: relative; height: 200px; margin-top: 15px; }
        .chart-container.tall { height: 280px; }

        /* === WEEK VIEW === */
        .week-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }

        .week-day-card {
            flex-shrink: 0;
            width: 110px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
        }
        .week-day-card.today { border: 2px solid var(--accent); }
        .week-day-header { text-align: center; margin-bottom: 10px; }
        .week-day-name { color: var(--accent); font-weight: 600; font-size: 0.9em; }
        .week-day-date { font-size: 0.8em; color: var(--muted); }

        .week-task {
            font-size: 0.75em;
            padding: 5px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .week-task.done { text-decoration: line-through; opacity: 0.5; }

        /* === GOALS === */
        .goal-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .goal-title { font-weight: 600; }
        .goal-deadline { font-size: 0.8em; color: var(--muted); }
        .goal-bar { height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .goal-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); }
        .goal-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .goal-pct { color: var(--accent); font-weight: bold; font-size: 0.9em; }
        .goal-btns { display: flex; gap: 8px; }

        /* === HEATMAP === */
        .heatmap { display: flex; flex-wrap: wrap; gap: 3px; }
        .heat-day { width: 12px; height: 12px; border-radius: 2px; background: rgba(255,255,255,0.1); }
        .heat-day.l1 { background: rgba(0,212,255,0.3); }
        .heat-day.l2 { background: rgba(0,212,255,0.5); }
        .heat-day.l3 { background: rgba(0,212,255,0.7); }
        .heat-day.l4 { background: var(--success); }

        /* === MOOD === */
        .mood-btns { display: flex; justify-content: center; gap: 8px; }
        .mood-btn { font-size: 2em; background: none; border: none; cursor: pointer; opacity: 0.5; transition: all 0.3s; padding: 8px; }
        .mood-btn:active, .mood-btn.selected { opacity: 1; transform: scale(1.2); }

        .mood-history { display: flex; gap: 5px; overflow-x: auto; padding: 10px 0; }
        .mood-day { flex-shrink: 0; text-align: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .mood-day-emoji { font-size: 1.3em; }
        .mood-day-date { font-size: 0.65em; color: var(--muted); }

        /* === ACHIEVEMENTS === */
        .achieve-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .achieve-item { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px 8px; text-align: center; border: 2px solid transparent; }
        .achieve-item.unlocked { background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,140,0,0.15)); border-color: var(--warning); }
        .achieve-item.locked { opacity: 0.4; filter: grayscale(1); }
        .achieve-icon { font-size: 1.6em; margin-bottom: 5px; }
        .achieve-name { font-size: 0.7em; font-weight: 600; }

        /* === WATER === */
        .water-display { text-align: center; }
        .water-count { font-size: 3em; color: var(--accent); font-weight: bold; }
        .water-glasses { display: flex; justify-content: center; gap: 6px; margin: 15px 0; flex-wrap: wrap; }
        .water-glass { width: 28px; height: 40px; border: 2px solid var(--accent); border-radius: 0 0 8px 8px; cursor: pointer; transition: all 0.2s; }
        .water-glass.filled { background: var(--accent); }
        .water-btns { display: flex; justify-content: center; gap: 10px; }

        /* === FOCUS === */
        .focus-card { text-align: center; background: linear-gradient(135deg, rgba(255,71,87,0.1), rgba(255,107,107,0.1)); }
        .focus-timer { font-size: 3.5em; font-family: monospace; font-weight: bold; background: linear-gradient(45deg, var(--accent), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 20px 0; }
        .focus-status { color: var(--muted); margin-bottom: 20px; }
        .focus-btns { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

        /* === JOURNAL === */
        .journal-entry { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .journal-date { font-size: 0.8em; color: var(--muted); margin-bottom: 8px; }
        .journal-text { line-height: 1.5; font-size: 0.95em; }

        /* === PROFILE === */
        .profile-header { text-align: center; padding: 30px 20px; }
        .profile-avatar { width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(45deg, var(--accent), var(--accent2)); display: flex; align-items: center; justify-content: center; font-size: 2.5em; margin: 0 auto 15px; }

        .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .avatar-opt { width: 42px; height: 42px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.4em; cursor: pointer; border: 2px solid transparent; }
        .avatar-opt.selected { border-color: var(--accent); }

        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .theme-opt { padding: 15px 8px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; font-size: 0.8em; }
        .theme-opt.selected { border-color: var(--accent); }

        /* === QUOTE === */
        .quote-card { background: linear-gradient(135deg, rgba(123,44,191,0.15), rgba(0,212,255,0.15)); text-align: center; cursor: pointer; }
        .quote-text { font-style: italic; line-height: 1.5; margin-bottom: 10px; font-size: 0.95em; }
        .quote-author { color: var(--accent); font-size: 0.85em; }

        /* === CHALLENGE === */
        .challenge-card { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1)); text-align: center; }
        .challenge-icon { font-size: 2.5em; margin-bottom: 10px; }
        .challenge-text { font-size: 1em; margin-bottom: 15px; }

        /* === MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            align-items: flex-end;
            justify-content: center;
            z-index: 2000;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg1);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 0 auto 15px; }
        .modal h3 { margin-bottom: 15px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btns .btn { flex: 1; }

        /* === CELEBRATE === */
        .celebrate {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            animation: pop 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 3000;
        }

        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        /* === THEMES === */
        .theme-ocean { --bg1: #0a1628; --bg2: #1a3a5c; --bg3: #2d5a7b; --accent: #00b4d8; --accent2: #0077b6; }
        .theme-forest { --bg1: #1a2f1a; --bg2: #2d4a2d; --bg3: #3d6b3d; --accent: #4ade80; --accent2: #22c55e; }
        .theme-sunset { --bg1: #2d1b2d; --bg2: #4a2c4a; --bg3: #6b3d6b; --accent: #f472b6; --accent2: #ec4899; }
        .theme-dark { --bg1: #0d0d0d; --bg2: #1a1a1a; --bg3: #2d2d2d; --accent: #ffffff; --accent2: #888; }
        .theme-light { --bg1: #f5f5f5; --bg2: #e8e8e8; --bg3: #ddd; --accent: #0066cc; --accent2: #0044aa; --text: #111; --muted: #666; --card: rgba(0,0,0,0.05); }

        /* === DESKTOP === */
        @media (min-width: 900px) {
            .mobile-header { display: none; }
            .bottom-nav { display: none; }
            .sidebar { display: flex; }
            
            .main {
                margin-left: var(--sidebar);
                padding: 30px 40px;
                max-width: 1000px;
            }
            
            .fab { bottom: 30px; right: 40px; }
            
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
            .grid-2 { grid-template-columns: repeat(2, 1fr); }
            
            .modal {
                border-radius: 20px;
                max-width: 450px;
                margin-bottom: 0;
            }
            
            .modal-overlay { align-items: center; }
            
            .chart-container { height: 250px; }
            .chart-container.tall { height: 320px; }
            
            .achieve-grid { grid-template-columns: repeat(4, 1fr); }
        }

        @media (min-width: 1200px) {
            .main { max-width: 1100px; }
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div class="app">
        <!-- SIDEBAR (Desktop) -->
        <aside class="sidebar">
            <div class="sidebar-logo">üöÄ Productivity Pro</div>
            <nav class="sidebar-nav">
                <button class="nav-link active" onclick="showPage('home')"><span class="icon">üè†</span> –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="nav-link" onclick="showPage('habits')"><span class="icon">‚úÖ</span> –ü—Ä–∏–≤—ã—á–∫–∏</button>
                <button class="nav-link" onclick="showPage('tasks')"><span class="icon">üìã</span> –ó–∞–¥–∞—á–∏</button>
                <button class="nav-link" onclick="showPage('goals')"><span class="icon">üéØ</span> –¶–µ–ª–∏</button>
                <button class="nav-link" onclick="showPage('focus')"><span class="icon">‚è±Ô∏è</span> –§–æ–∫—É—Å</button>
                <button class="nav-link" onclick="showPage('analytics')"><span class="icon">üìä</span> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                <button class="nav-link" onclick="showPage('journal')"><span class="icon">üìù</span> –ñ—É—Ä–Ω–∞–ª</button>
                <button class="nav-link" onclick="showPage('profile')"><span class="icon">üë§</span> –ü—Ä–æ—Ñ–∏–ª—å</button>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-xp" id="sideXP">0 XP</div>
                <div class="sidebar-level" id="sideLevel">–£—Ä–æ–≤–µ–Ω—å 1</div>
            </div>
        </aside>

        <!-- MOBILE HEADER -->
        <header class="mobile-header">
            <div class="m-logo">üöÄ Productivity</div>
            <div class="m-xp" id="mobileXP">0 XP</div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <!-- HOME -->
            <div id="p-home" class="page active">
                <div class="card" style="text-align:center;padding:25px;">
                    <div style="font-size:3em;margin-bottom:10px;" id="wAvatar">üòé</div>
                    <div style="font-size:1.4em;margin-bottom:5px;" id="wName">–ü—Ä–∏–≤–µ—Ç!</div>
                    <div style="color:var(--muted);" id="wDate"></div>
                </div>

                <div class="card level-card">
                    <div class="level-header">
                        <span class="level-badge">‚ö° –£—Ä–æ–≤–µ–Ω—å <span id="lvlNum">1</span></span>
                        <span class="xp-text"><span id="xpNow">0</span>/<span id="xpNeed">100</span></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="lvlBar"></div></div>
                    <div class="rank" id="rankText">üå± –ù–æ–≤–∏—á–æ–∫</div>
                </div>

                <div class="grid-4" style="margin-bottom:15px;">
                    <div class="stat-card"><div class="stat-icon">üî•</div><div class="stat-value" id="sStreak">0</div><div class="stat-label">–°—Ç—Ä–∏–∫</div></div>
                    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="sTotal">0</div><div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>
                    <div class="stat-card"><div class="stat-icon">üíß</div><div class="stat-value" id="sWater">0/8</div><div class="stat-label">–í–æ–¥–∞</div></div>
                    <div class="stat-card"><div class="stat-icon">üçÖ</div><div class="stat-value" id="sPomo">0</div><div class="stat-label">–ü–æ–º–æ–¥–æ—Ä–æ</div></div>
                </div>

                <div class="card challenge-card" id="challengeCard">
                    <div class="challenge-icon">üéØ</div>
                    <div class="challenge-text" id="challengeText">–í—ã–ø–æ–ª–Ω–∏ 3 –ø—Ä–∏–≤—ã—á–∫–∏!</div>
                    <button class="btn btn-sm btn-primary" id="challengeBtn" onclick="completeChallenge()">–í—ã–ø–æ–ª–Ω–∏—Ç—å (+50 XP)</button>
                </div>

                <div class="card">
                    <div class="card-title">üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                    <div class="mood-btns">
                        <button class="mood-btn" onclick="setMood('üò¢')">üò¢</button>
                        <button class="mood-btn" onclick="setMood('üòï')">üòï</button>
                        <button class="mood-btn" onclick="setMood('üòê')">üòê</button>
                        <button class="mood-btn" onclick="setMood('üôÇ')">üôÇ</button>
                        <button class="mood-btn" onclick="setMood('üòÑ')">üòÑ</button>
                    </div>
                    <div class="mood-history" id="moodHist"></div>
                </div>

                <div class="card quote-card" onclick="newQuote()">
                    <div class="quote-text" id="qText">"–£—Å–ø–µ—Ö ‚Äî —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π."</div>
                    <div class="quote-author" id="qAuthor">‚Äî –†. –ö–æ–ª—å–µ—Ä</div>
                </div>

                <div class="card">
                    <div class="card-title">üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                    <div class="heatmap" id="heatmap"></div>
                </div>
            </div>

            <!-- HABITS -->
            <div id="p-habits" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏</div>
                        <button class="btn btn-sm btn-primary" onclick="openModal('habitModal')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    <div id="habitsList"></div>
                </div>

                <div class="card">
                    <div class="card-title">üíß –í–æ–¥–∞</div>
                    <div class="water-display">
                        <div class="water-count"><span id="waterCount">0</span>/8</div>
                        <div class="water-glasses" id="waterGlasses"></div>
                        <div class="water-btns">
                            <button class="btn btn-sm btn-secondary" onclick="addWater(-1)">‚àí</button>
                            <button class="btn btn-sm btn-primary" onclick="addWater(1)">+ –°—Ç–∞–∫–∞–Ω</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏–≤—ã—á–µ–∫</div>
                    <div class="chart-container"><canvas id="habitsChart"></canvas></div>
                </div>
            </div>

            <!-- TASKS -->
            <div id="p-tasks" class="page">
                <div class="tabs" id="taskTabs">
                    <button class="tab active" onclick="switchTaskTab('day')">–î–µ–Ω—å</button>
                    <button class="tab" onclick="switchTaskTab('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="tab" onclick="switchTaskTab('month')">–ú–µ—Å—è—Ü</button>
                    <button class="tab" onclick="switchTaskTab('year')">–ì–æ–¥</button>
                </div>

                <!-- Tag Filter -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üè∑Ô∏è –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º</div>
                        <button class="btn btn-sm btn-secondary" onclick="openModal('tagModal')">+ –¢–µ–≥</button>
                    </div>
                    <div class="tags-container" id="tagFilter"></div>
                </div>

                <div id="taskContent"></div>

                <button class="fab" onclick="openModal('taskModal')">+</button>
            </div>

            <!-- GOALS -->
            <div id="p-goals" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üéØ –¶–µ–ª–∏</div>
                        <button class="btn btn-sm btn-primary" onclick="openModal('goalModal')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    <div id="goalsList"></div>
                </div>

                <div class="card">
                    <div class="card-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                    <div class="achieve-grid" id="achieveGrid"></div>
                </div>
            </div>

            <!-- FOCUS -->
            <div id="p-focus" class="page">
                <div class="card focus-card">
                    <div class="focus-timer" id="focusTime">25:00</div>
                    <div class="focus-status" id="focusStatus">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                    <div class="focus-btns">
                        <button class="btn btn-success" id="focusStartBtn" onclick="toggleFocus()">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                        <button class="btn btn-secondary" onclick="resetFocus()">‚Ü∫ –°–±—Ä–æ—Å</button>
                        <button class="btn btn-secondary" onclick="skipFocus()">‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="stat-card"><div class="stat-icon">üçÖ</div><div class="stat-value" id="focusToday">0</div><div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div></div>
                    <div class="stat-card"><div class="stat-icon">üèÜ</div><div class="stat-value" id="focusTotal">0</div><div class="stat-label">–í—Å–µ–≥–æ</div></div>
                </div>

                <div class="card">
                    <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">–†–∞–±–æ—Ç–∞ (–º–∏–Ω)</label>
                            <input type="number" class="input" id="focusWork" value="25" min="1" max="60">
                        </div>
                        <div class="input-group">
                            <label class="input-label">–ü–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                            <input type="number" class="input" id="focusBreak" value="5" min="1" max="30">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìä –§–æ–∫—É—Å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                    <div class="chart-container"><canvas id="focusChart"></canvas></div>
                </div>
            </div>

            <!-- ANALYTICS -->
            <div id="p-analytics" class="page">
                <div class="card">
                    <div class="card-title">üìà –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                    <div class="chart-container tall"><canvas id="weeklyChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-title">üìä –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –º–µ—Å—è—Ü</div>
                    <div class="chart-container tall"><canvas id="monthlyChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-title">üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–µ–∫</div>
                    <div class="chart-container"><canvas id="habitsPieChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-title">üòä –î–∏–Ω–∞–º–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</div>
                    <div class="chart-container"><canvas id="moodChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-title">üìã –ó–∞–¥–∞—á–∏ –ø–æ —Ç–µ–≥–∞–º</div>
                    <div class="chart-container"><canvas id="tagsChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-title">‚è∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</div>
                    <div class="chart-container"><canvas id="timeChart"></canvas></div>
                </div>
            </div>

            <!-- JOURNAL -->
            <div id="p-journal" class="page">
                <div class="card">
                    <div class="card-title">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
                    <textarea class="textarea" id="journalInput" placeholder="–ß—Ç–æ –Ω–∞ —É–º–µ?"></textarea>
                    <button class="btn btn-primary" onclick="addJournal()" style="margin-top:10px;width:100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <div id="journalList"></div>
            </div>

            <!-- PROFILE -->
            <div id="p-profile" class="page">
                <div class="card profile-header">
                    <div class="profile-avatar" id="pAvatar">üòé</div>
                    <div style="font-size:1.3em;margin-bottom:5px;" id="pName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div style="color:var(--muted);">–£—Ä–æ–≤–µ–Ω—å <span id="pLevel">1</span> ‚Ä¢ <span id="pRank">–ù–æ–≤–∏—á–æ–∫</span></div>
                </div>

                <div class="card">
                    <div class="card-title">‚úèÔ∏è –ò–º—è</div>
                    <input type="text" class="input" id="nameInput" placeholder="–¢–≤–æ—ë –∏–º—è" onchange="saveName()">
                </div>

                <div class="card">
                    <div class="card-title">üòä –ê–≤–∞—Ç–∞—Ä</div>
                    <div class="avatar-grid" id="avatarGrid"></div>
                </div>

                <div class="card">
                    <div class="card-title">üé® –¢–µ–º–∞</div>
                    <div class="theme-grid" id="themeGrid"></div>
                </div>

                <div class="card">
                    <div class="card-title">üíæ –î–∞–Ω–Ω—ã–µ</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="btn btn-secondary btn-sm" onclick="$('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
                        <input type="file" id="importFile" hidden accept=".json" onchange="importData(event)">
                        <button class="btn btn-danger btn-sm" onclick="resetAll()">üóëÔ∏è –°–±—Ä–æ—Å</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- BOTTOM NAV (Mobile) -->
    <nav class="bottom-nav">
        <button class="bnav-item active" onclick="showPage('home')"><span class="icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="bnav-item" onclick="showPage('habits')"><span class="icon">‚úÖ</span><span>–ü—Ä–∏–≤—ã—á–∫–∏</span></button>
        <button class="bnav-item" onclick="showPage('tasks')"><span class="icon">üìã</span><span>–ó–∞–¥–∞—á–∏</span></button>
        <button class="bnav-item" onclick="showPage('analytics')"><span class="icon">üìä</span><span>–ì—Ä–∞—Ñ–∏–∫–∏</span></button>
        <button class="bnav-item" onclick="showPage('profile')"><span class="icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </nav>

    <!-- MODALS -->
    <!-- Habit Modal -->
    <div class="modal-overlay" id="habitModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>‚úÖ –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</h3>
            <div class="input-group">
                <label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="input" id="habitName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: üèÉ –ü—Ä–æ–±–µ–∂–∫–∞">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('habitModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addHabit()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>üìã –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
            <div class="input-group">
                <label class="input-label">–ó–∞–¥–∞—á–∞</label>
                <input type="text" class="input" id="taskName" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            </div>
            <div class="input-group">
                <label class="input-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select class="input" id="taskPriority">
                    <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                    <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">–ü–µ—Ä–∏–æ–¥</label>
                <select class="input" id="taskPeriod">
                    <option value="day">–î–µ–Ω—å</option>
                    <option value="week">–ù–µ–¥–µ–ª—è</option>
                    <option value="month">–ú–µ—Å—è—Ü</option>
                    <option value="year">–ì–æ–¥</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">üè∑Ô∏è –¢–µ–≥–∏</label>
                <div class="tags-container" id="taskTagsSelect"></div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="modal-overlay" id="tagModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>üè∑Ô∏è –ù–æ–≤—ã–π —Ç–µ–≥</h3>
            <div class="input-group">
                <label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="input" id="tagName" placeholder="–†–∞–±–æ—Ç–∞, –£—á—ë–±–∞, –°–ø–æ—Ä—Ç...">
            </div>
            <div class="input-group">
                <label class="input-label">–¶–≤–µ—Ç</label>
                <div class="tag-colors" id="tagColors"></div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('tagModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addTag()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>üéØ –ù–æ–≤–∞—è —Ü–µ–ª—å</h3>
            <div class="input-group">
                <label class="input-label">–¶–µ–ª—å</label>
                <input type="text" class="input" id="goalName" placeholder="–ß–µ–≥–æ —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∏—á—å?">
            </div>
            <div class="input-group">
                <label class="input-label">–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                <input type="number" class="input" id="goalTarget" value="100" min="1">
            </div>
            <div class="input-group">
                <label class="input-label">–î–µ–¥–ª–∞–π–Ω</label>
                <input type="date" class="input" id="goalDeadline">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('goalModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addGoal()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // === DATA ===
        let D = {
            user: { name: '', avatar: 'üòé', theme: '' },
            habits: [], habitHistory: {},
            tasks: { day: {}, week: {}, month: {}, year: {} },
            tags: [],
            goals: [], journal: [], mood: {},
            water: {},
            focus: { total: 0, today: 0, lastDate: '', history: {} },
            xp: 0, maxStreak: 0, achievements: {},
            challenge: { date: '', done: false, idx: 0 }
        };

        const COLORS = ['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#9b59b6','#e056fd','#00d2d3','#ff9f43','#ee5a24','#10ac84'];
        const AVATARS = ['üòé','üöÄ','üí™','üî•','‚≠ê','üéØ','üíé','üëë','ü¶ä','üê±','üê∂','ü¶Å'];
        const THEMES = [
            { id: '', name: 'üåô –ö–æ—Å–º–æ—Å' },
            { id: 'theme-ocean', name: 'üåä –û–∫–µ–∞–Ω' },
            { id: 'theme-forest', name: 'üå≤ –õ–µ—Å' },
            { id: 'theme-sunset', name: 'üåÖ –ó–∞–∫–∞—Ç' },
            { id: 'theme-dark', name: '‚ö´ –¢—å–º–∞' },
            { id: 'theme-light', name: '‚òÄÔ∏è –°–≤–µ—Ç' }
        ];
        const QUOTES = [
            { t: "–£—Å–ø–µ—Ö ‚Äî —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π.", a: "–†. –ö–æ–ª—å–µ—Ä" },
            { t: "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî –º–æ—Å—Ç –º–µ–∂–¥—É —Ü–µ–ª—è–º–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏.", a: "–î–∂. –†–æ–Ω" },
            { t: "–¢—ã —É–ø–∞–¥—ë—à—å –¥–æ —É—Ä–æ–≤–Ω—è —Å–≤–æ–∏—Ö —Å–∏—Å—Ç–µ–º.", a: "–î–∂. –ö–ª–∏—Ä" },
            { t: "–î–µ–π—Å—Ç–≤–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.", a: "–ü. –ü–∏–∫–∞—Å—Å–æ" }
        ];
        const RANKS = [
            { l: 1, t: 'üå± –ù–æ–≤–∏—á–æ–∫' }, { l: 3, t: 'üåø –£—á–µ–Ω–∏–∫' }, { l: 5, t: 'üå≥ –ü—Ä–∞–∫—Ç–∏–∫' },
            { l: 8, t: '‚öîÔ∏è –í–æ–∏–Ω' }, { l: 12, t: 'üõ°Ô∏è –†—ã—Ü–∞—Ä—å' }, { l: 17, t: 'üëë –ú–∞—Å—Ç–µ—Ä' },
            { l: 25, t: 'üîÆ –ú—É–¥—Ä–µ—Ü' }, { l: 35, t: '‚≠ê –õ–µ–≥–µ–Ω–¥–∞' }
        ];
        const ACHIEVEMENTS = [
            { id: 'first', i: 'üéØ', n: '–ü–µ—Ä–≤—ã–π —à–∞–≥', c: () => D.habits.length >= 1 },
            { id: 'ten', i: 'üåü', n: '10 –∑–∞–¥–∞—á', c: () => getTotalDone() >= 10 },
            { id: 's7', i: 'üî•', n: '7 –¥–Ω–µ–π —Å—Ç—Ä–∏–∫', c: () => D.maxStreak >= 7 },
            { id: 'l5', i: 'üöÄ', n: '–£—Ä–æ–≤–µ–Ω—å 5', c: () => getLevel() >= 5 },
            { id: 'p10', i: 'üçÖ', n: '10 –ø–æ–º–æ–¥–æ—Ä–æ', c: () => D.focus.total >= 10 },
            { id: 'tags', i: 'üè∑Ô∏è', n: '5 —Ç–µ–≥–æ–≤', c: () => D.tags.length >= 5 }
        ];
        const CHALLENGES = [
            { t: '–í—ã–ø–æ–ª–Ω–∏ 3 –ø—Ä–∏–≤—ã—á–∫–∏', c: () => getTodayHabits() >= 3 },
            { t: '–í—ã–ø–µ–π 8 —Å—Ç–∞–∫–∞–Ω–æ–≤ –≤–æ–¥—ã', c: () => (D.water[today()] || 0) >= 8 },
            { t: '–°–¥–µ–ª–∞–π 2 –ø–æ–º–æ–¥–æ—Ä–æ', c: () => D.focus.today >= 2 }
        ];

        // Utils
        const $ = id => document.getElementById(id);
        const today = () => new Date().toISOString().split('T')[0];
        const save = () => localStorage.setItem('pt4', JSON.stringify(D));
        const load = () => { const s = localStorage.getItem('pt4'); if(s) D = {...D, ...JSON.parse(s)}; };

        let currentPage = 'home';
        let currentTaskTab = 'day';
        let selectedTags = [];
        let filterTag = null;
        let selectedTagColor = COLORS[0];

        // Charts
        let charts = {};

        // === INIT ===
        function init() {
            load();
            if (!D.habits.length) {
                D.habits = [{ id: 1, name: 'üèÉ –°–ø–æ—Ä—Ç' }, { id: 2, name: 'üìö –ß—Ç–µ–Ω–∏–µ' }, { id: 3, name: 'üíß –í–æ–¥–∞' }];
            }
            if (!D.tags.length) {
                D.tags = [
                    { id: 1, name: '–†–∞–±–æ—Ç–∞', color: '#4d96ff' },
                    { id: 2, name: '–õ–∏—á–Ω–æ–µ', color: '#6bcb77' },
                    { id: 3, name: '–£—á—ë–±–∞', color: '#9b59b6' }
                ];
            }
            applyTheme();
            updateAll();
            setupChallenge();
            renderTagColors();
        }

        function updateAll() {
            updateUI();
            renderHabits();
            renderWater();
            renderMood();
            renderHeatmap();
            renderTasks();
            renderGoals();
            renderAchievements();
            renderJournal();
            renderProfile();
            renderTagFilter();
            updateFocusDisplay();
            renderAllCharts();
        }

        // === PAGES ===
        function showPage(name) {
            currentPage = name;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            $('p-' + name)?.classList.add('active');
            document.querySelectorAll('.nav-link, .bnav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => { if(n.textContent.toLowerCase().includes(name.slice(0,4))) n.classList.add('active'); });
            event?.target?.closest('.bnav-item, .nav-link')?.classList.add('active');
            if (name === 'analytics') renderAllCharts();
        }

        // === UI ===
        function updateUI() {
            const name = D.user.name || '–î—Ä—É–≥';
            $('wName').textContent = `–ü—Ä–∏–≤–µ—Ç, ${name}!`;
            $('wAvatar').textContent = D.user.avatar;
            $('wDate').textContent = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
            
            $('mobileXP').textContent = D.xp + ' XP';
            $('sideXP').textContent = D.xp + ' XP';
            $('sideLevel').textContent = `–£—Ä–æ–≤–µ–Ω—å ${getLevel()} ‚Ä¢ ${getRank().replace(/[^\w\s–∞-—è–ê-–Ø]/g,'').trim()}`;

            const lvl = getLevel(), info = getXPInfo();
            $('lvlNum').textContent = lvl;
            $('xpNow').textContent = info.cur;
            $('xpNeed').textContent = info.need;
            $('lvlBar').style.width = (info.cur / info.need * 100) + '%';
            $('rankText').textContent = getRank();

            const streak = getStreak();
            D.maxStreak = Math.max(D.maxStreak, streak);
            $('sStreak').textContent = streak;
            $('sTotal').textContent = getTotalDone();
            $('sWater').textContent = (D.water[today()] || 0) + '/8';
            $('sPomo').textContent = D.focus.today;
            save();
        }

        // === LEVEL ===
        function getLevel() { let l=1,n=100,x=D.xp; while(x>=n){x-=n;l++;n=Math.floor(n*1.4);} return l; }
        function getXPInfo() { let l=1,n=100,x=D.xp; while(x>=n){x-=n;l++;n=Math.floor(n*1.4);} return {cur:x,need:n}; }
        function getRank() { const l=getLevel(); let r=RANKS[0].t; RANKS.forEach(x=>{if(l>=x.l)r=x.t;}); return r; }
        function addXP(n) { D.xp+=n; celebrate('‚ú®'); save(); updateUI(); checkAchievements(); }

        // === HABITS ===
        function renderHabits() {
            const t = today();
            if (!D.habitHistory[t]) D.habitHistory[t] = {};
            $('habitsList').innerHTML = D.habits.length ? D.habits.map(h => {
                const done = D.habitHistory[t][h.id] || false;
                const streak = getHabitStreak(h.id);
                const pct = getHabitPct(h.id);
                return `<div class="habit-item ${done?'done':''}">
                    <div class="habit-check ${done?'checked':''}" onclick="toggleHabit(${h.id})"></div>
                    <div class="habit-info"><div class="habit-name">${h.name}</div><div class="habit-streak">üî• ${streak} –¥–Ω.</div></div>
                    <div class="habit-pct">${pct}%</div>
                    <button class="delete-btn" onclick="deleteHabit(${h.id})">√ó</button>
                </div>`;
            }).join('') : '<p style="color:var(--muted);text-align:center;padding:20px;">–î–æ–±–∞–≤—å –ø—Ä–∏–≤—ã—á–∫—É! üéØ</p>';
        }

        function toggleHabit(id) {
            const t = today();
            if (!D.habitHistory[t]) D.habitHistory[t] = {};
            const was = D.habitHistory[t][id];
            D.habitHistory[t][id] = !was;
            if (!was) addXP(10); else D.xp = Math.max(0, D.xp - 10);
            save(); updateAll();
        }

        function addHabit() {
            const name = $('habitName').value.trim();
            if (name) { D.habits.push({ id: Date.now(), name }); save(); closeModal('habitModal'); $('habitName').value = ''; updateAll(); celebrate('üéØ'); }
        }

        function deleteHabit(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')){ D.habits = D.habits.filter(h=>h.id!==id); save(); renderHabits(); }}

        function getHabitStreak(id) { let s=0,d=new Date(); const t=today(); if(!D.habitHistory[t]?.[id])d.setDate(d.getDate()-1); while(true){const ds=d.toISOString().split('T')[0]; if(D.habitHistory[ds]?.[id]){s++;d.setDate(d.getDate()-1);}else break;} return s; }
        function getHabitPct(id) { let done=0,total=0; Object.values(D.habitHistory).forEach(day=>{if(day[id]!==undefined){total++;if(day[id])done++;}}); return total?Math.round(done/total*100):0; }
        function getStreak() { let s=0,d=new Date(); const t=today(); if(!D.habitHistory[t]||!Object.values(D.habitHistory[t]).some(v=>v))d.setDate(d.getDate()-1); while(true){const ds=d.toISOString().split('T')[0]; if(D.habitHistory[ds]&&Object.values(D.habitHistory[ds]).some(v=>v)){s++;d.setDate(d.getDate()-1);}else break;} return s; }
        function getTotalDone() { let t=0; Object.values(D.habitHistory).forEach(day=>{t+=Object.values(day).filter(v=>v).length;}); return t; }
        function getTodayHabits() { const t=today(); return D.habitHistory[t]?Object.values(D.habitHistory[t]).filter(v=>v).length:0; }

        // === TAGS ===
        function renderTagColors() {
            $('tagColors').innerHTML = COLORS.map(c => `<div class="color-btn ${selectedTagColor===c?'selected':''}" style="background:${c}" onclick="selectTagColor('${c}')"></div>`).join('');
        }

        function selectTagColor(c) { selectedTagColor = c; renderTagColors(); }

        function addTag() {
            const name = $('tagName').value.trim();
            if (name) {
                D.tags.push({ id: Date.now(), name, color: selectedTagColor });
                save(); closeModal('tagModal'); $('tagName').value = '';
                renderTagFilter(); renderTaskTagsSelect(); checkAchievements();
            }
        }

        function renderTagFilter() {
            $('tagFilter').innerHTML = `<button class="tag-btn ${filterTag===null?'selected':''}" style="background:rgba(255,255,255,0.1)" onclick="setFilterTag(null)">–í—Å–µ</button>` +
                D.tags.map(t => `<button class="tag-btn ${filterTag===t.id?'selected':''}" style="background:${t.color}" onclick="setFilterTag(${t.id})">${t.name}</button>`).join('');
        }

        function setFilterTag(id) { filterTag = id; renderTagFilter(); renderTasks(); }

        function renderTaskTagsSelect() {
            $('taskTagsSelect').innerHTML = D.tags.map(t => 
                `<button type="button" class="tag-btn ${selectedTags.includes(t.id)?'selected':''}" style="background:${t.color}" onclick="toggleTaskTag(${t.id})">${t.name}</button>`
            ).join('');
        }

        function toggleTaskTag(id) {
            if (selectedTags.includes(id)) selectedTags = selectedTags.filter(x => x !== id);
            else selectedTags.push(id);
            renderTaskTagsSelect();
        }

        // === TASKS ===
        function switchTaskTab(tab) {
            currentTaskTab = tab;
            document.querySelectorAll('#taskTabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }

        function getTaskKey(period) {
            const d = new Date();
            if (period === 'day') return today();
            if (period === 'week') return `${d.getFullYear()}-W${Math.ceil((d.getDate() + new Date(d.getFullYear(), 0, 1).getDay()) / 7)}`;
            if (period === 'month') return `${d.getFullYear()}-${d.getMonth() + 1}`;
            if (period === 'year') return d.getFullYear().toString();
        }

        function addTask() {
            const name = $('taskName').value.trim();
            const priority = $('taskPriority').value;
            const period = $('taskPeriod').value;
            if (name) {
                const key = getTaskKey(period);
                if (!D.tasks[period][key]) D.tasks[period][key] = [];
                D.tasks[period][key].push({ id: Date.now(), text: name, priority, done: false, tags: [...selectedTags], createdAt: new Date().toISOString() });
                save(); closeModal('taskModal'); $('taskName').value = ''; selectedTags = [];
                renderTasks();
            }
        }

        function toggleTask(period, key, id) {
            const task = D.tasks[period][key]?.find(t => t.id === id);
            if (task) { task.done = !task.done; if (task.done) addXP(5); save(); renderTasks(); }
        }

        function deleteTask(period, key, id) { D.tasks[period][key] = D.tasks[period][key].filter(t => t.id !== id); save(); renderTasks(); }

        function renderTasks() {
            const period = currentTaskTab;
            if (period === 'week') { renderWeekView(); return; }

            const key = getTaskKey(period);
            let tasks = D.tasks[period][key] || [];
            if (filterTag !== null) tasks = tasks.filter(t => t.tags?.includes(filterTag));

            const titles = { day: '–°–µ–≥–æ–¥–Ω—è', month: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü', year: '–≠—Ç–æ—Ç –≥–æ–¥' };

            $('taskContent').innerHTML = `<div class="card">
                <div class="card-title">üìã ${titles[period]}</div>
                ${tasks.length ? tasks.map(t => `
                    <div class="task-item ${t.done ? 'done' : ''}">
                        <div class="task-check ${t.done ? 'checked' : ''}" onclick="toggleTask('${period}','${key}',${t.id})"></div>
                        <div class="task-content">
                            <div class="task-text">${t.text}</div>
                            <div class="task-tags">${(t.tags||[]).map(tid => { const tag = D.tags.find(x=>x.id===tid); return tag ? `<span class="tag" style="background:${tag.color}">${tag.name}</span>` : ''; }).join('')}</div>
                        </div>
                        <div class="priority-dot priority-${t.priority}"></div>
                        <button class="delete-btn" onclick="deleteTask('${period}','${key}',${t.id})">√ó</button>
                    </div>
                `).join('') : '<p style="color:var(--muted);text-align:center;padding:20px;">–ù–µ—Ç –∑–∞–¥–∞—á</p>'}
            </div>`;
        }

        function renderWeekView() {
            const days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
            const d = new Date(); const dow = (d.getDay()+6)%7;
            const mon = new Date(d); mon.setDate(d.getDate() - dow);

            let html = '<div class="week-scroll">';
            for (let i = 0; i < 7; i++) {
                const date = new Date(mon); date.setDate(mon.getDate() + i);
                const ds = date.toISOString().split('T')[0];
                let tasks = D.tasks.day[ds] || [];
                if (filterTag !== null) tasks = tasks.filter(t => t.tags?.includes(filterTag));

                html += `<div class="week-day-card ${ds===today()?'today':''}">
                    <div class="week-day-header"><div class="week-day-name">${days[i]}</div><div class="week-day-date">${date.getDate()}</div></div>
                    ${tasks.slice(0,5).map(t => `<div class="week-task ${t.done?'done':''}" onclick="toggleTask('day','${ds}',${t.id})">${t.text}</div>`).join('')}
                </div>`;
            }
            html += '</div>';
            $('taskContent').innerHTML = html;
        }

        // === WATER ===
        function renderWater() {
            const count = D.water[today()] || 0;
            $('waterCount').textContent = count;
            let html = '';
            for (let i = 0; i < 8; i++) html += `<div class="water-glass ${i<count?'filled':''}" onclick="setWater(${i+1})"></div>`;
            $('waterGlasses').innerHTML = html;
        }

        function addWater(n) { const t=today(); D.water[t]=Math.max(0,Math.min(8,(D.water[t]||0)+n)); if(n>0)addXP(2); save(); renderWater(); updateUI(); }
        function setWater(n) { D.water[today()]=n; save(); renderWater(); updateUI(); }

        // === GOALS ===
        function addGoal() {
            const name = $('goalName').value.trim();
            const target = parseInt($('goalTarget').value) || 100;
            const deadline = $('goalDeadline').value;
            if (name) { D.goals.push({ id: Date.now(), name, target, current: 0, deadline }); save(); closeModal('goalModal'); $('goalName').value = ''; renderGoals(); celebrate('üéØ'); }
        }

        function updateGoal(id, delta) {
            const goal = D.goals.find(g => g.id === id);
            if (goal) { goal.current = Math.max(0, Math.min(goal.target, goal.current + delta)); if (goal.current === goal.target) celebrate('üèÜ'); save(); renderGoals(); }
        }

        function deleteGoal(id) { D.goals = D.goals.filter(g => g.id !== id); save(); renderGoals(); }

        function renderGoals() {
            $('goalsList').innerHTML = D.goals.length ? D.goals.map(g => {
                const pct = Math.round(g.current / g.target * 100);
                return `<div class="goal-item">
                    <div class="goal-header"><div class="goal-title">${g.name}</div><div class="goal-deadline">${g.deadline || ''}</div></div>
                    <div class="goal-bar"><div class="goal-fill" style="width:${pct}%"></div></div>
                    <div class="goal-footer">
                        <div class="goal-pct">${g.current}/${g.target}</div>
                        <div class="goal-btns">
                            <button class="btn btn-sm btn-secondary" onclick="updateGoal(${g.id},-1)">‚àí</button>
                            <button class="btn btn-sm btn-primary" onclick="updateGoal(${g.id},1)">+</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteGoal(${g.id})">√ó</button>
                        </div>
                    </div>
                </div>`;
            }).join('') : '<p style="color:var(--muted);text-align:center;padding:20px;">–î–æ–±–∞–≤—å —Ü–µ–ª—å! üéØ</p>';
        }

        // === FOCUS ===
        let focusInterval = null, focusSecs = 25 * 60, focusRunning = false, focusMode = 'work';

        function updateFocusDisplay() {
            const m = Math.floor(focusSecs / 60), s = focusSecs % 60;
            $('focusTime').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if (D.focus.lastDate !== today()) { D.focus.today = 0; D.focus.lastDate = today(); }
            $('focusToday').textContent = D.focus.today;
            $('focusTotal').textContent = D.focus.total;
        }

        function toggleFocus() {
            if (focusRunning) { clearInterval(focusInterval); focusRunning = false; $('focusStartBtn').innerHTML = '‚ñ∂ –°—Ç–∞—Ä—Ç'; }
            else {
                focusRunning = true; $('focusStartBtn').innerHTML = '‚è∏ –ü–∞—É–∑–∞';
                focusInterval = setInterval(() => {
                    focusSecs--;
                    updateFocusDisplay();
                    if (focusSecs <= 0) { clearInterval(focusInterval); focusRunning = false; focusComplete(); }
                }, 1000);
            }
        }

        function resetFocus() { clearInterval(focusInterval); focusRunning = false; focusMode = 'work'; focusSecs = (parseInt($('focusWork').value)||25)*60; updateFocusDisplay(); $('focusStartBtn').innerHTML = '‚ñ∂ –°—Ç–∞—Ä—Ç'; $('focusStatus').textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ'; }
        function skipFocus() { clearInterval(focusInterval); focusRunning = false; focusComplete(); }

        function focusComplete() {
            if (focusMode === 'work') {
                D.focus.total++; D.focus.today++;
                if (!D.focus.history[today()]) D.focus.history[today()] = 0;
                D.focus.history[today()]++;
                addXP(25); celebrate('üçÖ');
                focusMode = 'break'; focusSecs = (parseInt($('focusBreak').value)||5)*60;
                $('focusStatus').textContent = '‚òï –ü–µ—Ä–µ—Ä—ã–≤!';
            } else {
                focusMode = 'work'; focusSecs = (parseInt($('focusWork').value)||25)*60;
                $('focusStatus').textContent = 'üí™ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—Ç—å!';
            }
            save(); updateFocusDisplay(); updateUI();
            $('focusStartBtn').innerHTML = '‚ñ∂ –°—Ç–∞—Ä—Ç';
        }

        // === MOOD ===
        function setMood(emoji) { D.mood[today()] = emoji; save(); renderMood(); celebrate(emoji); }

        function renderMood() {
            const t = today();
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.toggle('selected', b.textContent === D.mood[t]));
            const dates = Object.keys(D.mood).sort().slice(-10);
            $('moodHist').innerHTML = dates.map(d => `<div class="mood-day"><div class="mood-day-emoji">${D.mood[d]}</div><div class="mood-day-date">${new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'short'})}</div></div>`).join('');
        }

        // === HEATMAP ===
        function renderHeatmap() {
            let html = '';
            for (let i = 59; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                let lvl = 0;
                if (D.habitHistory[ds]) {
                    const done = Object.values(D.habitHistory[ds]).filter(v => v).length;
                    const total = D.habits.length || 1;
                    const pct = done / total;
                    if (pct > 0) lvl = 1; if (pct >= 0.5) lvl = 2; if (pct >= 0.75) lvl = 3; if (pct >= 1) lvl = 4;
                }
                html += `<div class="heat-day l${lvl}" title="${ds}"></div>`;
            }
            $('heatmap').innerHTML = html;
        }

        // === ACHIEVEMENTS ===
        function checkAchievements() { ACHIEVEMENTS.forEach(a => { if (!D.achievements[a.id] && a.c()) { D.achievements[a.id] = true; celebrate('üèÜ'); }}); save(); renderAchievements(); }
        function renderAchievements() { $('achieveGrid').innerHTML = ACHIEVEMENTS.map(a => `<div class="achieve-item ${D.achievements[a.id]?'unlocked':'locked'}"><div class="achieve-icon">${a.i}</div><div class="achieve-name">${a.n}</div></div>`).join(''); }

        // === JOURNAL ===
        function addJournal() { const text = $('journalInput').value.trim(); if (text) { D.journal.unshift({ id: Date.now(), date: new Date().toISOString(), text }); save(); $('journalInput').value = ''; renderJournal(); addXP(5); }}
        function deleteJournal(id) { D.journal = D.journal.filter(e => e.id !== id); save(); renderJournal(); }
        function renderJournal() { $('journalList').innerHTML = D.journal.slice(0, 20).map(e => `<div class="card journal-entry"><div class="journal-date">${new Date(e.date).toLocaleString('ru-RU')}</div><div class="journal-text">${e.text}</div><button class="delete-btn" onclick="deleteJournal(${e.id})" style="float:right;margin-top:10px;">√ó</button></div>`).join(''); }

        // === CHALLENGE ===
        function setupChallenge() { const t = today(); if (D.challenge.date !== t) { D.challenge = { date: t, done: false, idx: Math.floor(Math.random() * CHALLENGES.length) }; save(); } renderChallenge(); }
        function renderChallenge() { const ch = CHALLENGES[D.challenge.idx]; $('challengeText').textContent = ch.t; $('challengeBtn').textContent = D.challenge.done ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ!' : '–í—ã–ø–æ–ª–Ω–∏—Ç—å (+50 XP)'; $('challengeBtn').disabled = D.challenge.done; if (D.challenge.done) $('challengeCard').style.opacity = '0.6'; }
        function completeChallenge() { const ch = CHALLENGES[D.challenge.idx]; if (ch.c() && !D.challenge.done) { D.challenge.done = true; addXP(50); save(); renderChallenge(); celebrate('üéâ'); } else if (!ch.c()) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ! üòä'); }}

        // === PROFILE ===
        function renderProfile() {
            $('pAvatar').textContent = D.user.avatar;
            $('pName').textContent = D.user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            $('pLevel').textContent = getLevel();
            $('pRank').textContent = getRank().replace(/[^\w\s–∞-—è–ê-–Ø]/g,'').trim();
            $('nameInput').value = D.user.name;
            $('avatarGrid').innerHTML = AVATARS.map(a => `<div class="avatar-opt ${D.user.avatar===a?'selected':''}" onclick="setAvatar('${a}')">${a}</div>`).join('');
            $('themeGrid').innerHTML = THEMES.map(t => `<div class="theme-opt ${D.user.theme===t.id?'selected':''}" style="background:linear-gradient(135deg,var(--bg1),var(--bg3));" onclick="setTheme('${t.id}')">${t.name}</div>`).join('');
        }

        function saveName() { D.user.name = $('nameInput').value; save(); updateAll(); }
        function setAvatar(a) { D.user.avatar = a; save(); updateAll(); }
        function setTheme(t) { D.user.theme = t; save(); applyTheme(); renderProfile(); }
        function applyTheme() { document.body.className = D.user.theme; }

        // === CHARTS ===
        function renderAllCharts() {
            renderHabitsBarChart();
            renderWeeklyChart();
            renderMonthlyChart();
            renderHabitsPieChart();
            renderMoodChart();
            renderTagsChart();
            renderTimeChart();
            renderFocusChart();
        }

        function renderHabitsBarChart() {
            const ctx = $('habitsChart')?.getContext('2d');
            if (!ctx) return;
            if (charts.habits) charts.habits.destroy();
            charts.habits = new Chart(ctx, {
                type: 'bar',
                data: { labels: D.habits.map(h => h.name.slice(0,12)), datasets: [{ data: D.habits.map(h => getHabitPct(h.id)), backgroundColor: COLORS.slice(0, D.habits.length), borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#888' }, grid: { display: false } } } }
            });
        }

        function renderWeeklyChart() {
            const ctx = $('weeklyChart')?.getContext('2d');
            if (!ctx) return;
            const labels = [], values = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                const ds = d.toISOString().split('T')[0];
                values.push(D.habitHistory[ds] ? Object.values(D.habitHistory[ds]).filter(v => v).length : 0);
            }
            if (charts.weekly) charts.weekly.destroy();
            charts.weekly = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: '–ü—Ä–∏–≤—ã—á–∫–∏', data: values, borderColor: '#00d4ff', backgroundColor: 'rgba(0,212,255,0.2)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#888' }, grid: { display: false } } } }
            });
        }

        function renderMonthlyChart() {
            const ctx = $('monthlyChart')?.getContext('2d');
            if (!ctx) return;
            const labels = [], values = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.getDate());
                const ds = d.toISOString().split('T')[0];
                const done = D.habitHistory[ds] ? Object.values(D.habitHistory[ds]).filter(v => v).length : 0;
                const total = D.habits.length || 1;
                values.push(Math.round(done / total * 100));
            }
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: values.map(v => v >= 80 ? '#00ff88' : v >= 50 ? '#ffd700' : '#ff6b6b'), borderRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#888', maxRotation: 0 }, grid: { display: false } } } }
            });
        }

        function renderHabitsPieChart() {
            const ctx = $('habitsPieChart')?.getContext('2d');
            if (!ctx) return;
            if (charts.pie) charts.pie.destroy();
            charts.pie = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: D.habits.map(h => h.name.slice(0,15)), datasets: [{ data: D.habits.map(h => getHabitPct(h.id)), backgroundColor: COLORS }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff', padding: 10 } } } }
            });
        }

        function renderMoodChart() {
            const ctx = $('moodChart')?.getContext('2d');
            if (!ctx) return;
            const moodToNum = { 'üò¢': 1, 'üòï': 2, 'üòê': 3, 'üôÇ': 4, 'üòÑ': 5 };
            const labels = [], values = [];
            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
                values.push(moodToNum[D.mood[ds]] || null);
            }
            if (charts.mood) charts.mood.destroy();
            charts.mood = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data: values, borderColor: '#f472b6', backgroundColor: 'rgba(244,114,182,0.2)', fill: true, tension: 0.4, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 1, max: 5, ticks: { color: '#888', callback: v => ['','üò¢','üòï','üòê','üôÇ','üòÑ'][v] }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#888', maxRotation: 45 }, grid: { display: false } } } }
            });
        }

        function renderTagsChart() {
            const ctx = $('tagsChart')?.getContext('2d');
            if (!ctx) return;
            const tagCounts = {};
            D.tags.forEach(t => tagCounts[t.id] = { name: t.name, color: t.color, count: 0 });
            Object.values(D.tasks).forEach(period => {
                Object.values(period).forEach(tasks => {
                    tasks.forEach(task => { (task.tags || []).forEach(tid => { if (tagCounts[tid]) tagCounts[tid].count++; }); });
                });
            });
            const data = Object.values(tagCounts);
            if (charts.tags) charts.tags.destroy();
            charts.tags = new Chart(ctx, {
                type: 'pie',
                data: { labels: data.map(d => d.name), datasets: [{ data: data.map(d => d.count), backgroundColor: data.map(d => d.color) }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
            });
        }

        function renderTimeChart() {
            const ctx = $('timeChart')?.getContext('2d');
            if (!ctx) return;
            const hours = Array(24).fill(0);
            Object.values(D.tasks).forEach(period => {
                Object.values(period).forEach(tasks => {
                    tasks.forEach(task => { if (task.createdAt) { const h = new Date(task.createdAt).getHours(); hours[h]++; } });
                });
            });
            if (charts.time) charts.time.destroy();
            charts.time = new Chart(ctx, {
                type: 'bar',
                data: { labels: hours.map((_, i) => i + ':00'), datasets: [{ data: hours, backgroundColor: 'rgba(0,212,255,0.6)', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#888', maxRotation: 90 }, grid: { display: false } } } }
            });
        }

        function renderFocusChart() {
            const ctx = $('focusChart')?.getContext('2d');
            if (!ctx) return;
            const labels = [], values = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                const ds = d.toISOString().split('T')[0];
                values.push(D.focus.history?.[ds] || 0);
            }
            if (charts.focus) charts.focus.destroy();
            charts.focus = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: '#ff6b6b', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#888' }, grid: { display: false } } } }
            });
        }

        // === QUOTE ===
        function newQuote() { const q = QUOTES[Math.floor(Math.random() * QUOTES.length)]; $('qText').textContent = `"${q.t}"`; $('qAuthor').textContent = `‚Äî ${q.a}`; }

        // === MODAL ===
        function openModal(id) { $(id).classList.add('active'); if (id === 'taskModal') { selectedTags = []; renderTaskTagsSelect(); } }
        function closeModal(id) { $(id).classList.remove('active'); }
        document.querySelectorAll('.modal-overlay').forEach(m => { m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }); });

        // === DATA ===
        function exportData() { const blob = new Blob([JSON.stringify(D, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'productivity-backup.json'; a.click(); }
        function importData(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = ev => { try { D = JSON.parse(ev.target.result); save(); updateAll(); alert('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!'); } catch { alert('–û—à–∏–±–∫–∞!'); } }; reader.readAsText(file); } }
        function resetAll() { if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) { localStorage.removeItem('pt4'); location.reload(); } }

        // === CELEBRATE ===
        function celebrate(emoji) { const el = document.createElement('div'); el.className = 'celebrate'; el.textContent = emoji; document.body.appendChild(el); setTimeout(() => el.remove(), 800); }

        // === START ===
        init();
    </script>
</body>
</html>
