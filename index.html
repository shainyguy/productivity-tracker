<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üöÄ Productivity Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Productivity Tracker&quot;,
        &quot;short_name&quot;: &quot;Tracker&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#1a1a2e&quot;,
        &quot;theme_color&quot;: &quot;#1a1a2e&quot;
    }">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg1: #1a1a2e;
            --bg2: #16213e;
            --bg3: #0f3460;
            --accent: #00d4ff;
            --accent2: #7b2cbf;
            --success: #00ff88;
            --warning: #ffd700;
            --danger: #ff4757;
            --text: #ffffff;
            --muted: #888;
            --card: rgba(255,255,255,0.05);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* === MOBILE NAV === */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
        }

        .logo {
            font-size: 1.3em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .xp-badge {
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }

        /* === BOTTOM NAV === */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--muted);
            text-decoration: none;
            font-size: 0.75em;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
        }

        .nav-item.active {
            color: var(--accent);
            background: rgba(0,212,255,0.1);
        }

        .nav-item .icon { font-size: 1.6em; }

        /* === MAIN === */
        .main {
            padding: 70px 12px 90px;
            max-width: 600px;
            margin: 0 auto;
        }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === CARDS === */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* === WELCOME === */
        .welcome-card {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(123,44,191,0.1));
        }

        .welcome-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            margin: 0 auto 15px;
        }

        .welcome-name { font-size: 1.5em; margin-bottom: 5px; }
        .welcome-date { color: var(--muted); }

        /* === LEVEL BAR === */
        .level-card {
            background: linear-gradient(135deg, rgba(123,44,191,0.2), rgba(0,212,255,0.2));
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .level-badge { font-weight: bold; }
        .xp-text { color: var(--warning); }

        .progress-bar {
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 6px;
            transition: width 0.5s;
        }

        .rank { text-align: center; margin-top: 8px; color: var(--warning); font-size: 0.9em; }

        /* === STATS GRID === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-icon { font-size: 1.5em; margin-bottom: 5px; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: var(--accent); }
        .stat-label { font-size: 0.8em; color: var(--muted); }

        /* === QUICK ACTIONS === */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-btn {
            background: var(--card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .quick-btn .icon { font-size: 1.5em; margin-bottom: 5px; }
        .quick-btn .label { font-size: 0.7em; color: var(--muted); }

        /* === HABITS === */
        .habit-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
            gap: 12px;
        }

        .habit-item.done { background: rgba(0,255,136,0.1); }

        .habit-check {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .habit-check.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .habit-check.checked::after { content: '‚úì'; color: #000; font-weight: bold; }

        .habit-info { flex: 1; min-width: 0; }
        .habit-name { font-size: 1em; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .habit-streak { font-size: 0.8em; color: var(--warning); }

        .habit-pct {
            background: rgba(0,212,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            color: var(--accent);
            font-weight: bold;
        }

        .habit-delete {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.5;
            padding: 5px;
        }

        /* === WATER TRACKER === */
        .water-tracker {
            text-align: center;
            padding: 20px;
        }

        .water-display {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .water-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }

        .water-glass {
            width: 30px;
            height: 45px;
            border: 2px solid var(--accent);
            border-radius: 0 0 8px 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .water-glass.filled { background: var(--accent); }
        .water-glass:active { transform: scale(0.9); }

        .water-btns { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }

        /* === FOCUS MODE === */
        .focus-card {
            text-align: center;
            background: linear-gradient(135deg, rgba(255,71,87,0.1), rgba(255,107,107,0.1));
        }

        .focus-timer {
            font-size: 4em;
            font-family: monospace;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        .focus-status { color: var(--muted); margin-bottom: 20px; }

        .focus-btns { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

        /* === SLEEP TRACKER === */
        .sleep-display {
            text-align: center;
            padding: 20px;
        }

        .sleep-hours {
            font-size: 4em;
            font-weight: bold;
            color: var(--accent);
        }

        .sleep-slider {
            width: 100%;
            margin: 20px 0;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            height: 10px;
            border-radius: 5px;
        }

        .sleep-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        /* === DAILY CHALLENGE === */
        .challenge-card {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1));
            text-align: center;
        }

        .challenge-icon { font-size: 3em; margin-bottom: 10px; }
        .challenge-text { font-size: 1.1em; margin-bottom: 15px; }
        .challenge-reward { color: var(--warning); font-size: 0.9em; }

        /* === MOOD === */
        .mood-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .mood-btn {
            font-size: 2em;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.3s;
            padding: 10px;
        }

        .mood-btn:active, .mood-btn.selected { opacity: 1; transform: scale(1.2); }

        .mood-history {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 10px 0;
            margin-top: 15px;
        }

        .mood-day {
            flex-shrink: 0;
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .mood-day-emoji { font-size: 1.3em; }
        .mood-day-date { font-size: 0.65em; color: var(--muted); }

        /* === TASKS === */
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            gap: 10px;
        }

        .task-item.done { opacity: 0.5; }
        .task-item.done .task-text { text-decoration: line-through; }

        .task-check {
            width: 22px;
            height: 22px;
            border: 2px solid var(--accent);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .task-check.checked { background: var(--success); border-color: var(--success); }
        .task-check.checked::after { content: '‚úì'; color: #000; font-size: 0.8em; }

        .task-text { flex: 1; font-size: 0.95em; }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .priority-high { background: var(--danger); }
        .priority-medium { background: var(--warning); }
        .priority-low { background: var(--success); }

        /* === TABS === */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 10px 16px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 10px;
            color: var(--muted);
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .tab.active { background: var(--accent); color: #000; }

        /* === GOALS === */
        .goal-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .goal-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .goal-title { font-weight: 600; }
        .goal-deadline { font-size: 0.8em; color: var(--muted); }

        .goal-bar {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .goal-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); }

        .goal-footer { display: flex; justify-content: space-between; align-items: center; }
        .goal-pct { color: var(--accent); font-weight: bold; font-size: 0.9em; }
        .goal-btns { display: flex; gap: 8px; }

        /* === BUTTONS === */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active { transform: scale(0.95); }

        .btn-primary { background: linear-gradient(45deg, var(--accent), var(--accent2)); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-sm { padding: 8px 14px; font-size: 0.85em; }
        .btn-icon { padding: 10px; font-size: 1.2em; }

        .btn-fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            border: none;
            font-size: 1.5em;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,212,255,0.4);
            z-index: 100;
        }

        /* === HEATMAP === */
        .heatmap {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .heat-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
        }

        .heat-day.l1 { background: rgba(0,212,255,0.3); }
        .heat-day.l2 { background: rgba(0,212,255,0.5); }
        .heat-day.l3 { background: rgba(0,212,255,0.7); }
        .heat-day.l4 { background: var(--success); }

        /* === ACHIEVEMENTS === */
        .achieve-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .achieve-item {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            border: 2px solid transparent;
        }

        .achieve-item.unlocked {
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,140,0,0.15));
            border-color: var(--warning);
        }

        .achieve-item.locked { opacity: 0.4; filter: grayscale(1); }
        .achieve-icon { font-size: 1.8em; margin-bottom: 5px; }
        .achieve-name { font-size: 0.75em; font-weight: 600; }

        /* === JOURNAL === */
        .journal-entry {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .journal-date { font-size: 0.8em; color: var(--muted); margin-bottom: 8px; }
        .journal-text { line-height: 1.5; font-size: 0.95em; }

        /* === PROFILE === */
        .profile-header {
            text-align: center;
            padding: 30px 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            margin: 0 auto 15px;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .avatar-opt {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .avatar-opt.selected { border-color: var(--accent); }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .theme-opt {
            padding: 20px 10px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 0.85em;
        }

        .theme-opt.selected { border-color: var(--accent); }
        .theme-opt.t1 { background: linear-gradient(135deg, #1a1a2e, #0f3460); }
        .theme-opt.t2 { background: linear-gradient(135deg, #0a1628, #2d5a7b); }
        .theme-opt.t3 { background: linear-gradient(135deg, #1a2f1a, #3d6b3d); }
        .theme-opt.t4 { background: linear-gradient(135deg, #2d1b2d, #6b3d6b); }
        .theme-opt.t5 { background: linear-gradient(135deg, #0d0d0d, #2d2d2d); }
        .theme-opt.t6 { background: linear-gradient(135deg, #1a1a1a, #3d3d3d); }

        /* === INPUTS === */
        .input, .textarea, .select {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-size: 1em;
        }

        .input:focus, .textarea:focus { outline: none; border-color: var(--accent); }
        .textarea { min-height: 100px; resize: vertical; }
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; margin-bottom: 6px; font-size: 0.9em; color: var(--muted); }

        /* === MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            align-items: flex-end;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg1);
            border-radius: 20px 20px 0 0;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .modal h3 { margin-bottom: 20px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns .btn { flex: 1; }

        /* === QUOTE === */
        .quote-card {
            background: linear-gradient(135deg, rgba(123,44,191,0.15), rgba(0,212,255,0.15));
            text-align: center;
        }

        .quote-text { font-style: italic; line-height: 1.6; margin-bottom: 10px; }
        .quote-author { color: var(--accent); font-size: 0.9em; }

        /* === CELEBRATE === */
        .celebrate {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            animation: pop 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 3000;
        }

        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        /* === WEEK VIEW === */
        .week-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-snap-type: x mandatory;
        }

        .week-day-card {
            flex-shrink: 0;
            width: 120px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            scroll-snap-align: start;
        }

        .week-day-card.today { border: 2px solid var(--accent); }
        .week-day-header { text-align: center; margin-bottom: 10px; }
        .week-day-name { color: var(--accent); font-weight: 600; }
        .week-day-date { font-size: 0.8em; color: var(--muted); }
        .week-task { font-size: 0.8em; padding: 6px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 5px; }
        .week-task.done { text-decoration: line-through; opacity: 0.5; }

        /* === THEMES === */
        .theme-ocean { --bg1: #0a1628; --bg2: #1a3a5c; --bg3: #2d5a7b; --accent: #00b4d8; --accent2: #0077b6; }
        .theme-forest { --bg1: #1a2f1a; --bg2: #2d4a2d; --bg3: #3d6b3d; --accent: #4ade80; --accent2: #22c55e; }
        .theme-sunset { --bg1: #2d1b2d; --bg2: #4a2c4a; --bg3: #6b3d6b; --accent: #f472b6; --accent2: #ec4899; }
        .theme-dark { --bg1: #0d0d0d; --bg2: #1a1a1a; --bg3: #2d2d2d; --accent: #ffffff; --accent2: #888; }
        .theme-light { --bg1: #f0f0f0; --bg2: #e0e0e0; --bg3: #d0d0d0; --accent: #0066cc; --accent2: #0044aa; --text: #000; --muted: #666; --card: rgba(0,0,0,0.05); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="mobile-header">
        <div class="logo">üöÄ Productivity</div>
        <div class="header-right">
            <div class="xp-badge" id="headerXP">0 XP</div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- HOME PAGE -->
        <div id="p-home" class="page active">
            <div class="card welcome-card">
                <div class="welcome-avatar" id="wAvatar">üòé</div>
                <div class="welcome-name" id="wName">–ü—Ä–∏–≤–µ—Ç!</div>
                <div class="welcome-date" id="wDate"></div>
            </div>

            <div class="card level-card">
                <div class="level-header">
                    <span class="level-badge">‚ö° –£—Ä–æ–≤–µ–Ω—å <span id="lvlNum">1</span></span>
                    <span class="xp-text"><span id="xpNow">0</span>/<span id="xpNeed">100</span></span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="lvlBar"></div></div>
                <div class="rank" id="rankText">üå± –ù–æ–≤–∏—á–æ–∫</div>
            </div>

            <div class="quick-actions">
                <div class="quick-btn" onclick="showPage('habits')">
                    <div class="icon">‚úÖ</div>
                    <div class="label">–ü—Ä–∏–≤—ã—á–∫–∏</div>
                </div>
                <div class="quick-btn" onclick="showPage('focus')">
                    <div class="icon">‚è±Ô∏è</div>
                    <div class="label">–§–æ–∫—É—Å</div>
                </div>
                <div class="quick-btn" onclick="showPage('tasks')">
                    <div class="icon">üìã</div>
                    <div class="label">–ó–∞–¥–∞—á–∏</div>
                </div>
                <div class="quick-btn" onclick="openModal('addModal')">
                    <div class="icon">‚ûï</div>
                    <div class="label">–î–æ–±–∞–≤–∏—Ç—å</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="sStreak">0</div>
                    <div class="stat-label">–°—Ç—Ä–∏–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="sTotal">0</div>
                    <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-value" id="sWater">0/8</div>
                    <div class="stat-label">–°—Ç–∞–∫–∞–Ω–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üçÖ</div>
                    <div class="stat-value" id="sPomo">0</div>
                    <div class="stat-label">–ü–æ–º–æ–¥–æ—Ä–æ</div>
                </div>
            </div>

            <!-- Daily Challenge -->
            <div class="card challenge-card" id="challengeCard">
                <div class="challenge-icon">üéØ</div>
                <div class="challenge-text" id="challengeText">–í—ã–ø–æ–ª–Ω–∏ 3 –ø—Ä–∏–≤—ã—á–∫–∏ —Å–µ–≥–æ–¥–Ω—è!</div>
                <button class="btn btn-sm btn-secondary" id="challengeBtn" onclick="completeChallenge()">–í—ã–ø–æ–ª–Ω–∏—Ç—å (+50 XP)</button>
            </div>

            <!-- Mood -->
            <div class="card">
                <div class="card-title">üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                <div class="mood-btns">
                    <button class="mood-btn" onclick="setMood('üò¢')">üò¢</button>
                    <button class="mood-btn" onclick="setMood('üòï')">üòï</button>
                    <button class="mood-btn" onclick="setMood('üòê')">üòê</button>
                    <button class="mood-btn" onclick="setMood('üôÇ')">üôÇ</button>
                    <button class="mood-btn" onclick="setMood('üòÑ')">üòÑ</button>
                </div>
                <div class="mood-history" id="moodHist"></div>
            </div>

            <!-- Quote -->
            <div class="card quote-card" onclick="newQuote()">
                <div class="quote-text" id="qText">"–£—Å–ø–µ—Ö ‚Äî —ç—Ç–æ —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π."</div>
                <div class="quote-author" id="qAuthor">‚Äî –†. –ö–æ–ª—å–µ—Ä</div>
            </div>

            <!-- Heatmap -->
            <div class="card">
                <div class="card-title">üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                <div class="heatmap" id="heatmap"></div>
            </div>
        </div>

        <!-- HABITS PAGE -->
        <div id="p-habits" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏</div>
                    <button class="btn btn-sm btn-primary" onclick="openModal('habitModal')">+</button>
                </div>
                <div id="habitsList"></div>
            </div>

            <!-- Water Tracker -->
            <div class="card">
                <div class="card-title">üíß –í–æ–¥–∞</div>
                <div class="water-tracker">
                    <div class="water-display"><span id="waterCount">0</span>/8</div>
                    <div class="water-progress" id="waterGlasses"></div>
                    <div class="water-btns">
                        <button class="btn btn-sm btn-secondary" onclick="addWater(-1)">‚àí</button>
                        <button class="btn btn-sm btn-primary" onclick="addWater(1)">+ –°—Ç–∞–∫–∞–Ω</button>
                    </div>
                </div>
            </div>

            <!-- Sleep -->
            <div class="card">
                <div class="card-title">üò¥ –°–æ–Ω</div>
                <div class="sleep-display">
                    <div class="sleep-hours"><span id="sleepHours">7</span>—á</div>
                    <input type="range" class="sleep-slider" id="sleepSlider" min="0" max="12" step="0.5" value="7" oninput="updateSleep()">
                    <button class="btn btn-sm btn-primary" onclick="saveSleep()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- FOCUS PAGE -->
        <div id="p-focus" class="page">
            <div class="card focus-card">
                <div class="focus-timer" id="focusTime">25:00</div>
                <div class="focus-status" id="focusStatus">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                <div class="focus-btns">
                    <button class="btn btn-success" id="focusStartBtn" onclick="toggleFocus()">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                    <button class="btn btn-secondary" onclick="resetFocus()">‚Ü∫</button>
                    <button class="btn btn-secondary" onclick="skipFocus()">‚è≠</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="input-group">
                    <label class="input-label">–†–∞–±–æ—Ç–∞ (–º–∏–Ω)</label>
                    <input type="number" class="input" id="focusWork" value="25" min="1" max="60">
                </div>
                <div class="input-group">
                    <label class="input-label">–ü–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                    <input type="number" class="input" id="focusBreak" value="5" min="1" max="30">
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üçÖ</div>
                    <div class="stat-value" id="focusToday">0</div>
                    <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="focusTotal">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ</div>
                </div>
            </div>
        </div>

        <!-- TASKS PAGE -->
        <div id="p-tasks" class="page">
            <div class="tabs" id="taskTabs">
                <button class="tab active" onclick="switchTaskTab('day')">–î–µ–Ω—å</button>
                <button class="tab" onclick="switchTaskTab('week')">–ù–µ–¥–µ–ª—è</button>
                <button class="tab" onclick="switchTaskTab('month')">–ú–µ—Å—è—Ü</button>
                <button class="tab" onclick="switchTaskTab('year')">–ì–æ–¥</button>
            </div>

            <div id="taskContent"></div>

            <button class="btn-fab" onclick="openTaskModal()">+</button>
        </div>

        <!-- GOALS PAGE -->
        <div id="p-goals" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ –¶–µ–ª–∏</div>
                    <button class="btn btn-sm btn-primary" onclick="openModal('goalModal')">+</button>
                </div>
                <div id="goalsList"></div>
            </div>

            <!-- Achievements -->
            <div class="card">
                <div class="card-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <div class="achieve-grid" id="achieveGrid"></div>
            </div>
        </div>

        <!-- JOURNAL PAGE -->
        <div id="p-journal" class="page">
            <div class="card">
                <div class="card-title">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
                <textarea class="textarea" id="journalInput" placeholder="–ß—Ç–æ –Ω–∞ —É–º–µ?"></textarea>
                <button class="btn btn-primary" onclick="addJournal()" style="margin-top:10px;width:100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div id="journalList"></div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="p-profile" class="page">
            <div class="card profile-header">
                <div class="profile-avatar" id="pAvatar">üòé</div>
                <div class="welcome-name" id="pName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div style="color:var(--muted)">–£—Ä–æ–≤–µ–Ω—å <span id="pLevel">1</span> ‚Ä¢ <span id="pRank">–ù–æ–≤–∏—á–æ–∫</span></div>
            </div>

            <div class="card">
                <div class="card-title">‚úèÔ∏è –ò–º—è</div>
                <input type="text" class="input" id="nameInput" placeholder="–¢–≤–æ—ë –∏–º—è" onchange="saveName()">
            </div>

            <div class="card">
                <div class="card-title">üòä –ê–≤–∞—Ç–∞—Ä</div>
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>

            <div class="card">
                <div class="card-title">üé® –¢–µ–º–∞</div>
                <div class="theme-grid" id="themeGrid"></div>
            </div>

            <div class="card">
                <div class="card-title">üíæ –î–∞–Ω–Ω—ã–µ</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn btn-secondary btn-sm" onclick="$('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
                    <input type="file" id="importFile" hidden accept=".json" onchange="importData(event)">
                    <button class="btn btn-danger btn-sm" onclick="resetAll()">üóëÔ∏è –°–±—Ä–æ—Å</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <canvas id="statsChart" height="200"></canvas>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showPage('home')">
            <span class="icon">üè†</span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-item" onclick="showPage('habits')">
            <span class="icon">‚úÖ</span>
            <span>–ü—Ä–∏–≤—ã—á–∫–∏</span>
        </button>
        <button class="nav-item" onclick="showPage('tasks')">
            <span class="icon">üìã</span>
            <span>–ó–∞–¥–∞—á–∏</span>
        </button>
        <button class="nav-item" onclick="showPage('goals')">
            <span class="icon">üéØ</span>
            <span>–¶–µ–ª–∏</span>
        </button>
        <button class="nav-item" onclick="showPage('profile')">
            <span class="icon">üë§</span>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>

    <!-- MODALS -->
    <!-- Add Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å</h3>
            <div style="display:grid;gap:10px;">
                <button class="btn btn-secondary" onclick="closeModal('addModal');openModal('habitModal')">‚úÖ –ü—Ä–∏–≤—ã—á–∫—É</button>
                <button class="btn btn-secondary" onclick="closeModal('addModal');openTaskModal()">üìã –ó–∞–¥–∞—á—É</button>
                <button class="btn btn-secondary" onclick="closeModal('addModal');openModal('goalModal')">üéØ –¶–µ–ª—å</button>
                <button class="btn btn-secondary" onclick="closeModal('addModal');showPage('journal')">üìù –ó–∞–ø–∏—Å—å</button>
            </div>
        </div>
    </div>

    <!-- Habit Modal -->
    <div class="modal-overlay" id="habitModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>‚úÖ –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</h3>
            <div class="input-group">
                <label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="input" id="habitName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: üèÉ –ü—Ä–æ–±–µ–∂–∫–∞">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('habitModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addHabit()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>üìã –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
            <div class="input-group">
                <label class="input-label">–ó–∞–¥–∞—á–∞</label>
                <input type="text" class="input" id="taskName" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            </div>
            <div class="input-group">
                <label class="input-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select class="input" id="taskPriority">
                    <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                    <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">–ü–µ—Ä–∏–æ–¥</label>
                <select class="input" id="taskPeriod">
                    <option value="day">–î–µ–Ω—å</option>
                    <option value="week">–ù–µ–¥–µ–ª—è</option>
                    <option value="month">–ú–µ—Å—è—Ü</option>
                    <option value="year">–ì–æ–¥</option>
                </select>
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>üéØ –ù–æ–≤–∞—è —Ü–µ–ª—å</h3>
            <div class="input-group">
                <label class="input-label">–¶–µ–ª—å</label>
                <input type="text" class="input" id="goalName" placeholder="–ß–µ–≥–æ —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∏—á—å?">
            </div>
            <div class="input-group">
                <label class="input-label">–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                <input type="number" class="input" id="goalTarget" value="100" min="1">
            </div>
            <div class="input-group">
                <label class="input-label">–î–µ–¥–ª–∞–π–Ω</label>
                <input type="date" class="input" id="goalDeadline">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeModal('goalModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="addGoal()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // === DATA ===
        let D = {
            user: { name: '', avatar: 'üòé', theme: '' },
            habits: [], habitHistory: {},
            tasks: { day: {}, week: {}, month: {}, year: {} },
            goals: [], journal: [], mood: {},
            water: {}, sleep: {},
            focus: { total: 0, today: 0, lastDate: '' },
            xp: 0, maxStreak: 0, achievements: {},
            challenge: { date: '', done: false }
        };

        const AVATARS = ['üòé','üöÄ','üí™','üî•','‚≠ê','üéØ','üíé','üëë','ü¶ä','üê±','üê∂','ü¶Å'];
        const THEMES = [
            { id: '', name: 'üåô –ö–æ—Å–º–æ—Å', cls: 't1' },
            { id: 'theme-ocean', name: 'üåä –û–∫–µ–∞–Ω', cls: 't2' },
            { id: 'theme-forest', name: 'üå≤ –õ–µ—Å', cls: 't3' },
            { id: 'theme-sunset', name: 'üåÖ –ó–∞–∫–∞—Ç', cls: 't4' },
            { id: 'theme-dark', name: '‚ö´ –¢—å–º–∞', cls: 't5' },
            { id: 'theme-light', name: '‚òÄÔ∏è –°–≤–µ—Ç', cls: 't6' }
        ];

        const QUOTES = [
            { t: "–£—Å–ø–µ—Ö ‚Äî —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π.", a: "–†. –ö–æ–ª—å–µ—Ä" },
            { t: "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî –º–æ—Å—Ç –º–µ–∂–¥—É —Ü–µ–ª—è–º–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏.", a: "–î–∂. –†–æ–Ω" },
            { t: "–ú–∞–ª–µ–Ω—å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è ‚Äî –∫–ª—é—á –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º.", a: "–†. –®–∞—Ä–º–∞" },
            { t: "–¢—ã —É–ø–∞–¥—ë—à—å –¥–æ —É—Ä–æ–≤–Ω—è —Å–≤–æ–∏—Ö —Å–∏—Å—Ç–µ–º.", a: "–î–∂. –ö–ª–∏—Ä" },
            { t: "–î–µ–π—Å—Ç–≤–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.", a: "–ü. –ü–∏–∫–∞—Å—Å–æ" },
            { t: "–ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –±—ã–ª –Ω–æ–≤–∏—á–∫–æ–º.", a: "–•. –•–µ–π—Å" }
        ];

        const RANKS = [
            { l: 1, t: 'üå± –ù–æ–≤–∏—á–æ–∫' }, { l: 3, t: 'üåø –£—á–µ–Ω–∏–∫' }, { l: 5, t: 'üå≥ –ü—Ä–∞–∫—Ç–∏–∫' },
            { l: 8, t: '‚öîÔ∏è –í–æ–∏–Ω' }, { l: 12, t: 'üõ°Ô∏è –†—ã—Ü–∞—Ä—å' }, { l: 17, t: 'üëë –ú–∞—Å—Ç–µ—Ä' },
            { l: 25, t: 'üîÆ –ú—É–¥—Ä–µ—Ü' }, { l: 35, t: '‚≠ê –õ–µ–≥–µ–Ω–¥–∞' }, { l: 50, t: 'üí´ –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π' }
        ];

        const ACHIEVEMENTS = [
            { id: 'first', i: 'üéØ', n: '–ü–µ—Ä–≤—ã–π —à–∞–≥', c: () => D.habits.length >= 1 },
            { id: 'ten', i: 'üåü', n: '10 –∑–∞–¥–∞—á', c: () => getTotalDone() >= 10 },
            { id: 'fifty', i: 'üí™', n: '50 –∑–∞–¥–∞—á', c: () => getTotalDone() >= 50 },
            { id: 's3', i: 'üî•', n: '3 –¥–Ω—è —Å—Ç—Ä–∏–∫', c: () => D.maxStreak >= 3 },
            { id: 's7', i: '‚ö°', n: '7 –¥–Ω–µ–π —Å—Ç—Ä–∏–∫', c: () => D.maxStreak >= 7 },
            { id: 's30', i: 'üëë', n: '30 –¥–Ω–µ–π!', c: () => D.maxStreak >= 30 },
            { id: 'l5', i: 'üöÄ', n: '–£—Ä–æ–≤–µ–Ω—å 5', c: () => getLevel() >= 5 },
            { id: 'l10', i: 'üíé', n: '–£—Ä–æ–≤–µ–Ω—å 10', c: () => getLevel() >= 10 },
            { id: 'p10', i: 'üçÖ', n: '10 –ø–æ–º–æ–¥–æ—Ä–æ', c: () => D.focus.total >= 10 }
        ];

        const CHALLENGES = [
            { t: '–í—ã–ø–æ–ª–Ω–∏ 3 –ø—Ä–∏–≤—ã—á–∫–∏', c: () => getTodayHabits() >= 3 },
            { t: '–í—ã–ø–µ–π 8 —Å—Ç–∞–∫–∞–Ω–æ–≤ –≤–æ–¥—ã', c: () => (D.water[today()] || 0) >= 8 },
            { t: '–°–¥–µ–ª–∞–π 2 –ø–æ–º–æ–¥–æ—Ä–æ', c: () => D.focus.today >= 2 },
            { t: '–î–æ–±–∞–≤—å –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª', c: () => D.journal.some(j => j.date.startsWith(today())) },
            { t: '–í—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏', c: () => getTodayHabits() >= D.habits.length && D.habits.length > 0 }
        ];

        // === UTILS ===
        const $ = id => document.getElementById(id);
        const today = () => new Date().toISOString().split('T')[0];
        const save = () => localStorage.setItem('pt3', JSON.stringify(D));
        const load = () => { const s = localStorage.getItem('pt3'); if(s) D = {...D, ...JSON.parse(s)}; };

        // === INIT ===
        function init() {
            load();
            if (!D.habits.length) {
                D.habits = [
                    { id: 1, name: 'üèÉ –°–ø–æ—Ä—Ç' },
                    { id: 2, name: 'üìö –ß—Ç–µ–Ω–∏–µ' },
                    { id: 3, name: 'üíß –í–æ–¥–∞' },
                    { id: 4, name: 'üßò –ú–µ–¥–∏—Ç–∞—Ü–∏—è' }
                ];
            }
            applyTheme();
            updateAll();
            setupChallenge();
        }

        function updateAll() {
            updateUI();
            renderHabits();
            renderWater();
            renderMood();
            renderHeatmap();
            renderTasks();
            renderGoals();
            renderAchievements();
            renderJournal();
            renderProfile();
            updateFocusDisplay();
        }

        // === PAGES ===
        let currentPage = 'home';
        let currentTaskTab = 'day';

        function showPage(name) {
            currentPage = name;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            $('p-' + name)?.classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => {
                if (n.textContent.toLowerCase().includes(name.slice(0, 3)) || 
                    (name === 'home' && n.textContent.includes('–ì–ª–∞–≤–Ω–∞—è')) ||
                    (name === 'focus' && n.textContent.includes('–ó–∞–¥–∞—á–∏'))) {
                    // n.classList.add('active');
                }
            });
            event?.target?.closest('.nav-item')?.classList.add('active');
        }

        // === UI ===
        function updateUI() {
            const name = D.user.name || '–î—Ä—É–≥';
            $('wName').textContent = `–ü—Ä–∏–≤–µ—Ç, ${name}!`;
            $('wAvatar').textContent = D.user.avatar;
            $('wDate').textContent = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
            
            $('headerXP').textContent = D.xp + ' XP';
            
            const lvl = getLevel();
            const xpInfo = getXPInfo();
            $('lvlNum').textContent = lvl;
            $('xpNow').textContent = xpInfo.cur;
            $('xpNeed').textContent = xpInfo.need;
            $('lvlBar').style.width = (xpInfo.cur / xpInfo.need * 100) + '%';
            $('rankText').textContent = getRank();

            const streak = getStreak();
            D.maxStreak = Math.max(D.maxStreak, streak);
            $('sStreak').textContent = streak;
            $('sTotal').textContent = getTotalDone();
            $('sWater').textContent = (D.water[today()] || 0) + '/8';
            $('sPomo').textContent = D.focus.today;

            save();
        }

        // === LEVEL ===
        function getLevel() {
            let l = 1, n = 100, x = D.xp;
            while (x >= n) { x -= n; l++; n = Math.floor(n * 1.4); }
            return l;
        }

        function getXPInfo() {
            let l = 1, n = 100, x = D.xp;
            while (x >= n) { x -= n; l++; n = Math.floor(n * 1.4); }
            return { cur: x, need: n };
        }

        function getRank() {
            const l = getLevel();
            let r = RANKS[0].t;
            RANKS.forEach(x => { if (l >= x.l) r = x.t; });
            return r;
        }

        function addXP(n) {
            D.xp += n;
            celebrate('‚ú®');
            save();
            updateUI();
            checkAchievements();
        }

        // === HABITS ===
        function renderHabits() {
            const t = today();
            if (!D.habitHistory[t]) D.habitHistory[t] = {};

            $('habitsList').innerHTML = D.habits.length ? D.habits.map(h => {
                const done = D.habitHistory[t][h.id] || false;
                const streak = getHabitStreak(h.id);
                const pct = getHabitPct(h.id);
                return `
                    <div class="habit-item ${done ? 'done' : ''}">
                        <div class="habit-check ${done ? 'checked' : ''}" onclick="toggleHabit(${h.id})"></div>
                        <div class="habit-info">
                            <div class="habit-name">${h.name}</div>
                            <div class="habit-streak">üî• ${streak} –¥–Ω.</div>
                        </div>
                        <div class="habit-pct">${pct}%</div>
                        <button class="habit-delete" onclick="deleteHabit(${h.id})">√ó</button>
                    </div>
                `;
            }).join('') : '<p style="color:var(--muted);text-align:center;padding:20px;">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É! üéØ</p>';
        }

        function toggleHabit(id) {
            const t = today();
            if (!D.habitHistory[t]) D.habitHistory[t] = {};
            const was = D.habitHistory[t][id];
            D.habitHistory[t][id] = !was;
            if (!was) addXP(10); else D.xp = Math.max(0, D.xp - 10);
            save();
            updateAll();
        }

        function addHabit() {
            const name = $('habitName').value.trim();
            if (name) {
                const id = Date.now();
                D.habits.push({ id, name });
                save();
                closeModal('habitModal');
                $('habitName').value = '';
                updateAll();
                celebrate('üéØ');
            }
        }

        function deleteHabit(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                D.habits = D.habits.filter(h => h.id !== id);
                save();
                renderHabits();
            }
        }

        function getHabitStreak(id) {
            let s = 0, d = new Date();
            const t = today();
            if (!D.habitHistory[t]?.[id]) d.setDate(d.getDate() - 1);
            while (true) {
                const ds = d.toISOString().split('T')[0];
                if (D.habitHistory[ds]?.[id]) { s++; d.setDate(d.getDate() - 1); }
                else break;
            }
            return s;
        }

        function getHabitPct(id) {
            let done = 0, total = 0;
            Object.values(D.habitHistory).forEach(day => {
                if (day[id] !== undefined) { total++; if (day[id]) done++; }
            });
            return total ? Math.round(done / total * 100) : 0;
        }

        function getStreak() {
            let s = 0, d = new Date();
            const t = today();
            if (!D.habitHistory[t] || !Object.values(D.habitHistory[t]).some(v => v)) d.setDate(d.getDate() - 1);
            while (true) {
                const ds = d.toISOString().split('T')[0];
                if (D.habitHistory[ds] && Object.values(D.habitHistory[ds]).some(v => v)) {
                    s++; d.setDate(d.getDate() - 1);
                } else break;
            }
            return s;
        }

        function getTotalDone() {
            let t = 0;
            Object.values(D.habitHistory).forEach(day => { t += Object.values(day).filter(v => v).length; });
            return t;
        }

        function getTodayHabits() {
            const t = today();
            return D.habitHistory[t] ? Object.values(D.habitHistory[t]).filter(v => v).length : 0;
        }

        // === WATER ===
        function renderWater() {
            const count = D.water[today()] || 0;
            $('waterCount').textContent = count;
            let html = '';
            for (let i = 0; i < 8; i++) {
                html += `<div class="water-glass ${i < count ? 'filled' : ''}" onclick="setWater(${i + 1})"></div>`;
            }
            $('waterGlasses').innerHTML = html;
        }

        function addWater(n) {
            const t = today();
            D.water[t] = Math.max(0, Math.min(8, (D.water[t] || 0) + n));
            if (n > 0 && D.water[t] <= 8) addXP(2);
            save();
            renderWater();
            updateUI();
        }

        function setWater(n) {
            D.water[today()] = n;
            save();
            renderWater();
            updateUI();
        }

        // === SLEEP ===
        function updateSleep() {
            $('sleepHours').textContent = $('sleepSlider').value;
        }

        function saveSleep() {
            D.sleep[today()] = parseFloat($('sleepSlider').value);
            addXP(5);
            save();
            celebrate('üò¥');
        }

        // === FOCUS/POMODORO ===
        let focusInterval = null;
        let focusSecs = 25 * 60;
        let focusRunning = false;
        let focusMode = 'work';

        function updateFocusDisplay() {
            const m = Math.floor(focusSecs / 60);
            const s = focusSecs % 60;
            $('focusTime').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            if (D.focus.lastDate !== today()) {
                D.focus.today = 0;
                D.focus.lastDate = today();
            }
            $('focusToday').textContent = D.focus.today;
            $('focusTotal').textContent = D.focus.total;
        }

        function toggleFocus() {
            if (focusRunning) {
                clearInterval(focusInterval);
                focusRunning = false;
                $('focusStartBtn').innerHTML = '‚ñ∂ –°—Ç–∞—Ä—Ç';
            } else {
                focusRunning = true;
                $('focusStartBtn').innerHTML = '‚è∏ –ü–∞—É–∑–∞';
                focusInterval = setInterval(() => {
                    focusSecs--;
                    updateFocusDisplay();
                    if (focusSecs <= 0) {
                        clearInterval(focusInterval);
                        focusRunning = false;
                        focusComplete();
                    }
                }, 1000);
            }
        }

        function resetFocus() {
            clearInterval(focusInterval);
            focusRunning = false;
            focusMode = 'work';
            focusSecs = (parseInt($('focusWork').value) || 25) * 60;
            updateFocusDisplay();
            $('focusStartBtn').innerHTML = '‚ñ∂ –°—Ç–∞—Ä—Ç';
            $('focusStatus').textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';
        }

        function skipFocus() {
            clearInterval(focusInterval);
            focusRunning = false;
            focusComplete();
        }

        function focusComplete() {
            if (focusMode === 'work') {
                D.focus.total++;
                D.focus.today++;
                addXP(25);
                celebrate('üçÖ');
                focusMode = 'break';
                focusSecs = (parseInt($('focusBreak').value) || 5) * 60;
                $('focusStatus').textContent = '‚òï –ü–µ—Ä–µ—Ä—ã–≤!';
            } else {
                focusMode = 'work';
                focusSecs = (parseInt($('focusWork').value) || 25) * 60;
                $('focusStatus').textContent = 'üí™ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—Ç—å!';
            }
            save();
            updateFocusDisplay();
            updateUI();
            $('focusStartBtn').innerHTML = '‚ñ∂ –°—Ç–∞—Ä—Ç';
        }

        // === MOOD ===
        function setMood(emoji) {
            D.mood[today()] = emoji;
            save();
            renderMood();
            celebrate(emoji);
        }

        function renderMood() {
            const t = today();
            document.querySelectorAll('.mood-btn').forEach(b => {
                b.classList.toggle('selected', b.textContent === D.mood[t]);
            });
            
            const dates = Object.keys(D.mood).sort().slice(-10);
            $('moodHist').innerHTML = dates.map(d => `
                <div class="mood-day">
                    <div class="mood-day-emoji">${D.mood[d]}</div>
                    <div class="mood-day-date">${new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}</div>
                </div>
            `).join('');
        }

        // === TASKS ===
        function switchTaskTab(tab) {
            currentTaskTab = tab;
            document.querySelectorAll('#taskTabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }

        function openTaskModal() {
            $('taskPeriod').value = currentTaskTab;
            openModal('taskModal');
        }

        function getTaskKey(period) {
            const d = new Date();
            if (period === 'day') return today();
            if (period === 'week') return `${d.getFullYear()}-W${Math.ceil((d.getDate() + new Date(d.getFullYear(), 0, 1).getDay()) / 7)}`;
            if (period === 'month') return `${d.getFullYear()}-${d.getMonth() + 1}`;
            if (period === 'year') return d.getFullYear().toString();
        }

        function addTask() {
            const name = $('taskName').value.trim();
            const priority = $('taskPriority').value;
            const period = $('taskPeriod').value;
            if (name) {
                const key = getTaskKey(period);
                if (!D.tasks[period][key]) D.tasks[period][key] = [];
                D.tasks[period][key].push({ id: Date.now(), text: name, priority, done: false });
                save();
                closeModal('taskModal');
                $('taskName').value = '';
                renderTasks();
            }
        }

        function toggleTask(period, key, id) {
            const task = D.tasks[period][key]?.find(t => t.id === id);
            if (task) {
                task.done = !task.done;
                if (task.done) addXP(5);
                save();
                renderTasks();
            }
        }

        function deleteTask(period, key, id) {
            D.tasks[period][key] = D.tasks[period][key].filter(t => t.id !== id);
            save();
            renderTasks();
        }

        function renderTasks() {
            const period = currentTaskTab;
            
            if (period === 'week') {
                renderWeekView();
                return;
            }
            
            const key = getTaskKey(period);
            const tasks = D.tasks[period][key] || [];
            
            const titles = { day: '–°–µ–≥–æ–¥–Ω—è', month: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü', year: '–≠—Ç–æ—Ç –≥–æ–¥' };
            
            $('taskContent').innerHTML = `
                <div class="card">
                    <div class="card-title">üìã ${titles[period]}</div>
                    ${tasks.length ? tasks.map(t => `
                        <div class="task-item ${t.done ? 'done' : ''}">
                            <div class="task-check ${t.done ? 'checked' : ''}" onclick="toggleTask('${period}','${key}',${t.id})"></div>
                            <div class="task-text">${t.text}</div>
                            <div class="priority-dot priority-${t.priority}"></div>
                            <button class="habit-delete" onclick="deleteTask('${period}','${key}',${t.id})">√ó</button>
                        </div>
                    `).join('') : '<p style="color:var(--muted);text-align:center;padding:20px;">–ù–µ—Ç –∑–∞–¥–∞—á</p>'}
                </div>
            `;
        }

        function renderWeekView() {
            const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            const d = new Date();
            const dow = (d.getDay() + 6) % 7;
            const mon = new Date(d);
            mon.setDate(d.getDate() - dow);

            let html = '<div class="week-scroll">';
            for (let i = 0; i < 7; i++) {
                const date = new Date(mon);
                date.setDate(mon.getDate() + i);
                const ds = date.toISOString().split('T')[0];
                const isToday = ds === today();
                const tasks = D.tasks.day[ds] || [];

                html += `
                    <div class="week-day-card ${isToday ? 'today' : ''}">
                        <div class="week-day-header">
                            <div class="week-day-name">${days[i]}</div>
                            <div class="week-day-date">${date.getDate()}</div>
                        </div>
                        ${tasks.map(t => `<div class="week-task ${t.done ? 'done' : ''}" onclick="toggleTask('day','${ds}',${t.id})">${t.text}</div>`).join('')}
                    </div>
                `;
            }
            html += '</div>';
            $('taskContent').innerHTML = html;
        }

        // === GOALS ===
        function addGoal() {
            const name = $('goalName').value.trim();
            const target = parseInt($('goalTarget').value) || 100;
            const deadline = $('goalDeadline').value;
            if (name) {
                D.goals.push({ id: Date.now(), name, target, current: 0, deadline });
                save();
                closeModal('goalModal');
                $('goalName').value = '';
                renderGoals();
                celebrate('üéØ');
            }
        }

        function updateGoal(id, delta) {
            const goal = D.goals.find(g => g.id === id);
            if (goal) {
                goal.current = Math.max(0, Math.min(goal.target, goal.current + delta));
                if (goal.current === goal.target) celebrate('üèÜ');
                save();
                renderGoals();
            }
        }

        function deleteGoal(id) {
            D.goals = D.goals.filter(g => g.id !== id);
            save();
            renderGoals();
        }

        function renderGoals() {
            $('goalsList').innerHTML = D.goals.length ? D.goals.map(g => {
                const pct = Math.round(g.current / g.target * 100);
                return `
                    <div class="goal-item">
                        <div class="goal-header">
                            <div class="goal-title">${g.name}</div>
                            <div class="goal-deadline">${g.deadline || ''}</div>
                        </div>
                        <div class="goal-bar"><div class="goal-fill" style="width:${pct}%"></div></div>
                        <div class="goal-footer">
                            <div class="goal-pct">${g.current}/${g.target}</div>
                            <div class="goal-btns">
                                <button class="btn btn-sm btn-secondary" onclick="updateGoal(${g.id},-1)">‚àí</button>
                                <button class="btn btn-sm btn-primary" onclick="updateGoal(${g.id},1)">+</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGoal(${g.id})">√ó</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') : '<p style="color:var(--muted);text-align:center;padding:20px;">–î–æ–±–∞–≤—å —Ü–µ–ª—å! üéØ</p>';
        }

        // === ACHIEVEMENTS ===
        function checkAchievements() {
            ACHIEVEMENTS.forEach(a => {
                if (!D.achievements[a.id] && a.c()) {
                    D.achievements[a.id] = true;
                    celebrate('üèÜ');
                }
            });
            save();
            renderAchievements();
        }

        function renderAchievements() {
            $('achieveGrid').innerHTML = ACHIEVEMENTS.map(a => `
                <div class="achieve-item ${D.achievements[a.id] ? 'unlocked' : 'locked'}">
                    <div class="achieve-icon">${a.i}</div>
                    <div class="achieve-name">${a.n}</div>
                </div>
            `).join('');
        }

        // === JOURNAL ===
        function addJournal() {
            const text = $('journalInput').value.trim();
            if (text) {
                D.journal.unshift({ id: Date.now(), date: new Date().toISOString(), text });
                save();
                $('journalInput').value = '';
                renderJournal();
                addXP(5);
            }
        }

        function deleteJournal(id) {
            D.journal = D.journal.filter(e => e.id !== id);
            save();
            renderJournal();
        }

        function renderJournal() {
            $('journalList').innerHTML = D.journal.slice(0, 20).map(e => `
                <div class="card journal-entry">
                    <div class="journal-date">${new Date(e.date).toLocaleString('ru-RU')}</div>
                    <div class="journal-text">${e.text}</div>
                    <button class="habit-delete" onclick="deleteJournal(${e.id})" style="float:right;margin-top:10px;">√ó</button>
                </div>
            `).join('');
        }

        // === CHALLENGE ===
        function setupChallenge() {
            const t = today();
            if (D.challenge.date !== t) {
                D.challenge = { date: t, done: false, idx: Math.floor(Math.random() * CHALLENGES.length) };
                save();
            }
            renderChallenge();
        }

        function renderChallenge() {
            const ch = CHALLENGES[D.challenge.idx];
            $('challengeText').textContent = ch.t;
            $('challengeBtn').textContent = D.challenge.done ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ!' : '–í—ã–ø–æ–ª–Ω–∏—Ç—å (+50 XP)';
            $('challengeBtn').disabled = D.challenge.done;
            if (D.challenge.done) $('challengeCard').style.opacity = '0.6';
        }

        function completeChallenge() {
            const ch = CHALLENGES[D.challenge.idx];
            if (ch.c() && !D.challenge.done) {
                D.challenge.done = true;
                addXP(50);
                save();
                renderChallenge();
                celebrate('üéâ');
            } else if (!ch.c()) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ! üòä');
            }
        }

        // === HEATMAP ===
        function renderHeatmap() {
            let html = '';
            for (let i = 59; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                let lvl = 0;
                if (D.habitHistory[ds]) {
                    const done = Object.values(D.habitHistory[ds]).filter(v => v).length;
                    const total = D.habits.length || 1;
                    const pct = done / total;
                    if (pct > 0) lvl = 1;
                    if (pct >= 0.5) lvl = 2;
                    if (pct >= 0.75) lvl = 3;
                    if (pct >= 1) lvl = 4;
                }
                html += `<div class="heat-day l${lvl}" title="${ds}"></div>`;
            }
            $('heatmap').innerHTML = html;
        }

        // === PROFILE ===
        function renderProfile() {
            $('pAvatar').textContent = D.user.avatar;
            $('pName').textContent = D.user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            $('pLevel').textContent = getLevel();
            $('pRank').textContent = getRank().replace(/[^\w\s–∞-—è–ê-–Ø]/g, '').trim();
            $('nameInput').value = D.user.name;

            $('avatarGrid').innerHTML = AVATARS.map(a => 
                `<div class="avatar-opt ${D.user.avatar === a ? 'selected' : ''}" onclick="setAvatar('${a}')">${a}</div>`
            ).join('');

            $('themeGrid').innerHTML = THEMES.map(t => 
                `<div class="theme-opt ${t.cls} ${D.user.theme === t.id ? 'selected' : ''}" onclick="setTheme('${t.id}')">${t.name}</div>`
            ).join('');

            renderStatsChart();
        }

        function saveName() {
            D.user.name = $('nameInput').value;
            save();
            updateAll();
        }

        function setAvatar(a) {
            D.user.avatar = a;
            save();
            updateAll();
        }

        function setTheme(t) {
            D.user.theme = t;
            save();
            applyTheme();
            renderProfile();
        }

        function applyTheme() {
            document.body.className = D.user.theme;
        }

        function renderStatsChart() {
            const ctx = $('statsChart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = [], values = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                const ds = d.toISOString().split('T')[0];
                values.push(D.habitHistory[ds] ? Object.values(D.habitHistory[ds]).filter(v => v).length : 0);
            }

            if (window.statsChart) window.statsChart.destroy();
            window.statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: 'rgba(0,212,255,0.6)', borderRadius: 6 }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#888' }, grid: { display: false } }
                    }
                }
            });
        }

        // === DATA ===
        function exportData() {
            const blob = new Blob([JSON.stringify(D, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'productivity-backup.json';
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        D = JSON.parse(ev.target.result);
                        save();
                        updateAll();
                        alert('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
                    } catch { alert('–û—à–∏–±–∫–∞!'); }
                };
                reader.readAsText(file);
            }
        }

        function resetAll() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
                localStorage.removeItem('pt3');
                location.reload();
            }
        }

        // === MODAL ===
        function openModal(id) { $(id).classList.add('active'); }
        function closeModal(id) { $(id).classList.remove('active'); }

        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
        });

        // === QUOTE ===
        function newQuote() {
            const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            $('qText').textContent = `"${q.t}"`;
            $('qAuthor').textContent = `‚Äî ${q.a}`;
        }

        // === CELEBRATE ===
        function celebrate(emoji) {
            const el = document.createElement('div');
            el.className = 'celebrate';
            el.textContent = emoji;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // === START ===
        init();
    </script>
</body>
</html>
