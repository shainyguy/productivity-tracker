<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üöÄ Productivity Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: rgba(255,255,255,0.03);
            --bg-card-hover: rgba(255,255,255,0.06);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
            --accent-glow: rgba(99,102,241,0.4);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255,255,255,0.06);
            --border-accent: rgba(99,102,241,0.3);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow-glow: 0 0 40px var(--accent-glow);
            --sidebar-width: 260px;
            --header-height: 64px;
            --nav-height: 72px;
        }

        .theme-light {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --bg-card: rgba(0,0,0,0.02);
            --bg-card-hover: rgba(0,0,0,0.04);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: rgba(0,0,0,0.06);
        }

        .theme-ocean {
            --bg-primary: #0c1222;
            --bg-secondary: #111827;
            --bg-tertiary: #1e293b;
            --accent-primary: #06b6d4;
            --accent-secondary: #0ea5e9;
            --accent-gradient: linear-gradient(135deg, #06b6d4, #0ea5e9, #3b82f6);
            --accent-glow: rgba(6,182,212,0.4);
        }

        .theme-forest {
            --bg-primary: #0a1410;
            --bg-secondary: #0f1f18;
            --bg-tertiary: #1a2f24;
            --accent-primary: #10b981;
            --accent-secondary: #34d399;
            --accent-gradient: linear-gradient(135deg, #10b981, #34d399, #6ee7b7);
            --accent-glow: rgba(16,185,129,0.4);
        }

        .theme-sunset {
            --bg-primary: #1a0a0f;
            --bg-secondary: #2a1015;
            --bg-tertiary: #3d1a22;
            --accent-primary: #f43f5e;
            --accent-secondary: #fb7185;
            --accent-gradient: linear-gradient(135deg, #f43f5e, #fb7185, #fda4af);
            --accent-glow: rgba(244,63,94,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        .app-container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .sidebar-logo { font-size: 1.25rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .sidebar-user { display: flex; align-items: center; gap: 12px; padding: 16px 24px; border-bottom: 1px solid var(--border); }
        .sidebar-user img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .sidebar-user-info { flex: 1; min-width: 0; }
        .sidebar-user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar-user-email { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: var(--radius-md); color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s; margin-bottom: 4px;
            border: none; background: none; width: 100%; font-size: 0.9rem; text-align: left;
        }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .nav-item.active { background: rgba(99,102,241,0.1); color: var(--accent-primary); }
        .nav-item .icon { font-size: 1.2rem; width: 24px; text-align: center; }

        .sidebar-footer { padding: 16px 24px; border-top: 1px solid var(--border); }
        .sidebar-xp { text-align: center; padding: 16px; background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 12px; }
        .sidebar-xp-value { font-size: 1.5rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-xp-label { font-size: 0.75rem; color: var(--text-muted); }

        .logout-btn { width: 100%; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: var(--radius-md); color: var(--danger); cursor: pointer; font-size: 0.9rem; }

        /* Mobile Header */
        .mobile-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 1000; backdrop-filter: blur(20px);
        }
        .mobile-logo { font-size: 1.1rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .mobile-header-right { display: flex; align-items: center; gap: 12px; }
        .xp-badge { background: var(--accent-gradient); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; }
        .mobile-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid var(--border); }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height);
            background: var(--bg-secondary); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom); z-index: 1000; backdrop-filter: blur(20px);
        }
        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 8px 12px; border-radius: var(--radius-md); color: var(--text-muted);
            cursor: pointer; transition: all 0.2s; border: none; background: none; font-size: 0.65rem;
        }
        .bottom-nav-item.active { color: var(--accent-primary); }
        .bottom-nav-item .icon { font-size: 1.5rem; }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 16px);
            max-width: 100%;
            margin: 0 auto;
        }

        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        /* Date Navigation */
        .date-nav {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 12px 16px; margin-bottom: 16px;
        }
        .date-nav-btn {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 10px 16px; color: var(--text-primary);
            cursor: pointer; font-size: 1.2rem; transition: all 0.2s;
        }
        .date-nav-btn:hover { background: var(--bg-card-hover); }
        .date-nav-current {
            text-align: center; flex: 1;
        }
        .date-nav-title { font-size: 1.1rem; font-weight: 600; }
        .date-nav-subtitle { font-size: 0.8rem; color: var(--text-muted); }
        .date-nav-today {
            background: var(--accent-gradient); border: none; border-radius: var(--radius-md);
            padding: 8px 12px; color: white; cursor: pointer; font-size: 0.8rem; margin-left: 10px;
        }

        /* Quick Date Buttons */
        .quick-dates {
            display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px;
        }
        .quick-date-btn {
            flex-shrink: 0; padding: 10px 16px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
        }
        .quick-date-btn:hover { background: var(--bg-card-hover); }
        .quick-date-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }

        /* Calendar Mini */
        .calendar-mini {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
            margin-bottom: 16px;
        }
        .calendar-day-header {
            text-align: center; font-size: 0.7rem; color: var(--text-muted);
            padding: 8px 0; font-weight: 600;
        }
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85rem;
            transition: all 0.2s; position: relative;
        }
        .calendar-day:hover { background: var(--bg-card-hover); }
        .calendar-day.today { border-color: var(--accent-primary); color: var(--accent-primary); font-weight: 600; }
        .calendar-day.selected { background: var(--accent-primary); color: white; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.has-tasks::after {
            content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--success); border-radius: 50%;
        }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .tab {
            padding: 10px 18px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-md); color: var(--text-muted); cursor: pointer;
            white-space: nowrap; font-size: 0.85rem; transition: all 0.2s;
        }
        .tab.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }

        /* Buttons */
        .btn {
            padding: 12px 20px; border: none; border-radius: var(--radius-md);
            font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-gradient); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-danger { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); color: var(--danger); }
        .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

        .fab {
            position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px;
            width: 56px; height: 56px; border-radius: 50%; background: var(--accent-gradient);
            color: white; font-size: 1.5rem; border: none; cursor: pointer;
            box-shadow: var(--shadow-glow); z-index: 99;
        }

        /* Inputs */
        .input, .textarea, .select {
            width: 100%; padding: 14px 16px; background: var(--bg-tertiary);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            color: var(--text-primary); font-size: 0.95rem; transition: all 0.2s;
        }
        .input:focus, .textarea:focus, .select:focus { outline: none; border-color: var(--accent-primary); }
        .textarea { min-height: 100px; resize: vertical; }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }

        /* Tasks */
        .task-item {
            display: flex; align-items: flex-start; padding: 14px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-md); margin-bottom: 8px; gap: 12px;
        }
        .task-item.done { opacity: 0.5; }
        .task-item.done .task-text { text-decoration: line-through; }

        .task-check {
            width: 22px; height: 22px; border: 2px solid var(--accent-primary);
            border-radius: 6px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0; margin-top: 2px;
        }
        .task-check.checked { background: var(--success); border-color: var(--success); }
        .task-check.checked::after { content: '‚úì'; color: white; font-size: 0.75rem; }

        .task-content { flex: 1; min-width: 0; }
        .task-text { font-size: 0.9rem; margin-bottom: 6px; }
        .task-meta { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .task-date { font-size: 0.75rem; color: var(--text-muted); }
        .task-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .tag { padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 500; }

        .priority-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
        .priority-high { background: var(--danger); }
        .priority-medium { background: var(--warning); }
        .priority-low { background: var(--success); }

        .delete-btn { background: none; border: none; color: var(--danger); cursor: pointer; opacity: 0.5; font-size: 1.2rem; padding: 4px; }
        .delete-btn:hover { opacity: 1; }

        /* Tags */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-btn { padding: 6px 14px; border-radius: 20px; border: 2px solid transparent; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .tag-btn.selected { border-color: white; }
        .tag-colors { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-btn { width: 36px; height: 36px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-btn.selected { border-color: white; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; text-align: center; }
        .stat-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        /* Level */
        .level-card { background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15)); border: 1px solid var(--border-accent); }
        .level-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .level-badge { font-weight: 600; }
        .level-xp { color: var(--warning); font-weight: 600; }
        .progress-bar { height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-gradient); transition: width 0.5s; }
        .level-rank { text-align: center; margin-top: 8px; font-size: 0.9rem; color: var(--warning); }

        /* Weather */
        .weather-widget { background: var(--accent-gradient); border-radius: var(--radius-xl); padding: 24px; color: white; position: relative; overflow: hidden; margin-bottom: 16px; }
        .weather-main { display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 1; }
        .weather-temp { font-size: 3rem; font-weight: 700; }
        .weather-icon { font-size: 4rem; }
        .weather-details { display: flex; gap: 20px; margin-top: 16px; position: relative; z-index: 1; }
        .weather-detail { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; opacity: 0.9; }
        .weather-location { font-size: 0.9rem; opacity: 0.8; margin-top: 8px; }
        .weather-tip { margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: var(--radius-md); font-size: 0.85rem; }

        /* Mood */
        .mood-selector { display: flex; justify-content: center; gap: 8px; }
        .mood-btn { font-size: 2rem; background: none; border: none; cursor: pointer; opacity: 0.4; transition: all 0.2s; padding: 8px; }
        .mood-btn:hover, .mood-btn.selected { opacity: 1; transform: scale(1.2); }
        .mood-history { display: flex; gap: 8px; overflow-x: auto; padding: 12px 0; }
        .mood-day { flex-shrink: 0; text-align: center; padding: 10px; background: var(--bg-card); border-radius: var(--radius-md); min-width: 60px; }
        .mood-day-emoji { font-size: 1.5rem; }
        .mood-day-date { font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; }

        /* Heatmap */
        .heatmap { display: flex; flex-wrap: wrap; gap: 3px; }
        .heat-day { width: 14px; height: 14px; border-radius: 3px; background: var(--bg-tertiary); }
        .heat-day.l1 { background: rgba(99,102,241,0.3); }
        .heat-day.l2 { background: rgba(99,102,241,0.5); }
        .heat-day.l3 { background: rgba(99,102,241,0.7); }
        .heat-day.l4 { background: var(--success); }

        /* Quote */
        .quote-card { background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.1)); border-color: var(--border-accent); text-align: center; cursor: pointer; }
        .quote-text { font-size: 1rem; font-style: italic; line-height: 1.6; margin-bottom: 12px; }
        .quote-author { font-size: 0.85rem; color: var(--accent-primary); }

        /* Habits */
        .habit-item { display: flex; align-items: center; padding: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; gap: 14px; }
        .habit-item.done { background: rgba(16,185,129,0.1); border-color: rgba(16,185,129,0.2); }
        .habit-check { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--accent-primary); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .habit-check.checked { background: var(--success); border-color: var(--success); }
        .habit-check.checked::after { content: '‚úì'; color: white; font-weight: bold; }
        .habit-info { flex: 1; min-width: 0; }
        .habit-name { font-weight: 500; }
        .habit-streak { font-size: 0.8rem; color: var(--warning); }
        .habit-pct { background: rgba(99,102,241,0.1); color: var(--accent-primary); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }

        /* Water */
        .water-display { text-align: center; }
        .water-count { font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, #06b6d4, #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .water-glasses { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
        .water-glass { width: 32px; height: 44px; border: 2px solid var(--info); border-radius: 0 0 10px 10px; cursor: pointer; transition: all 0.2s; }
        .water-glass.filled { background: var(--info); }

        /* Focus */
        .focus-widget { text-align: center; padding: 32px; }
        .focus-timer { font-size: 4rem; font-weight: 700; font-family: monospace; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .focus-status { color: var(--text-muted); margin-bottom: 24px; }
        .focus-btns { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }

        /* Sleep */
        .sleep-widget { text-align: center; }
        .sleep-display { display: flex; align-items: baseline; justify-content: center; gap: 4px; margin-bottom: 20px; }
        .sleep-hours { font-size: 4rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sleep-unit { font-size: 1.5rem; color: var(--text-muted); }
        .sleep-slider { width: 100%; height: 8px; -webkit-appearance: none; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 20px; }
        .sleep-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: var(--accent-gradient); border-radius: 50%; cursor: pointer; }
        .sleep-quality { display: flex; justify-content: center; gap: 12px; margin-top: 16px; }
        .quality-btn { font-size: 2rem; background: none; border: none; cursor: pointer; opacity: 0.4; transition: all 0.2s; padding: 8px; }
        .quality-btn:hover, .quality-btn.selected { opacity: 1; transform: scale(1.2); }

        /* Goals */
        .goal-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; }
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .goal-title { font-weight: 600; }
        .goal-bar { height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin: 12px 0; }
        .goal-fill { height: 100%; background: var(--accent-gradient); }
        .goal-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .goal-pct { font-weight: 600; color: var(--accent-primary); font-size: 0.9rem; }
        .goal-btns { display: flex; gap: 8px; }

        /* Achievements */
        .achieve-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .achieve-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px 8px; text-align: center; }
        .achieve-item.unlocked { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(251,191,36,0.1)); border-color: rgba(245,158,11,0.3); }
        .achieve-item.locked { opacity: 0.4; filter: grayscale(1); }
        .achieve-icon { font-size: 1.8rem; margin-bottom: 6px; }
        .achieve-name { font-size: 0.7rem; font-weight: 600; }

        /* Journal */
        .journal-entry { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; }
        .journal-date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
        .journal-text { line-height: 1.6; font-size: 0.95rem; }

        /* Profile */
        .profile-header { text-align: center; padding: 32px 20px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background: var(--accent-gradient); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; overflow: hidden; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .theme-option { padding: 20px 16px; border-radius: var(--radius-md); text-align: center; cursor: pointer; border: 2px solid transparent; font-size: 0.85rem; }
        .theme-option.selected { border-color: var(--accent-primary); }
        .theme-option.t-dark { background: linear-gradient(135deg, #0a0a0f, #1a1a24); color: #fff; }
        .theme-option.t-light { background: linear-gradient(135deg, #f8fafc, #e2e8f0); color: #0f172a; }
        .theme-option.t-ocean { background: linear-gradient(135deg, #0c1222, #1e293b); color: #06b6d4; }
        .theme-option.t-forest { background: linear-gradient(135deg, #0a1410, #1a2f24); color: #10b981; }
        .theme-option.t-sunset { background: linear-gradient(135deg, #1a0a0f, #3d1a22); color: #f43f5e; }

        /* Chart */
        .chart-container { position: relative; height: 200px; margin-top: 16px; }
        .chart-container.tall { height: 280px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; padding: 24px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
        .modal h3 { margin-bottom: 20px; font-size: 1.1rem; }
        .modal-btns { display: flex; gap: 12px; margin-top: 20px; }
        .modal-btns .btn { flex: 1; }

        /* Auth */
        .auth-screen { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; }
        .auth-logo { font-size: 5rem; margin-bottom: 24px; }
        .auth-title { font-size: 2rem; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-muted); margin-bottom: 40px; }
        .google-btn { display: flex; align-items: center; gap: 12px; padding: 16px 32px; background: white; color: #333; border: none; border-radius: 50px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .google-btn img { width: 24px; height: 24px; }

        /* Loading */
        .loading { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Celebrate */
        .celebrate { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; animation: celebrate 0.8s ease-out forwards; pointer-events: none; z-index: 9999; }
        @keyframes celebrate { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }

        /* Desktop */
        @media (min-width: 900px) {
            .mobile-header { display: none !important; }
            .bottom-nav { display: none !important; }
            .sidebar { display: flex !important; }
            .main-content { margin-left: var(--sidebar-width); padding: 32px 40px; max-width: 900px; }
            .fab { bottom: 32px; right: 40px; }
            .modal { border-radius: var(--radius-xl); margin: auto; }
            .modal-overlay { align-items: center; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .achieve-grid { grid-template-columns: repeat(4, 1fr); }
            .chart-container { height: 250px; }
            .calendar-mini { max-width: 400px; }
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div class="auth-screen" id="authScreen" style="display:none;">
        <div class="auth-logo">üöÄ</div>
        <h1 class="auth-title">Productivity Pro</h1>
        <p class="auth-subtitle">–î–æ—Å—Ç–∏–≥–∞–π —Ü–µ–ª–µ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</p>
        <button class="google-btn" onclick="signInWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>
    </div>

    <div class="app-container" id="app" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="sidebar-logo">üöÄ Productivity Pro</div></div>
            <div class="sidebar-user"><img id="sidePhoto" src=""><div class="sidebar-user-info"><div class="sidebar-user-name" id="sideName">User</div><div class="sidebar-user-email" id="sideEmail">email</div></div></div>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="showPage('home')"><span class="icon">üè†</span> –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="nav-item" onclick="showPage('habits')"><span class="icon">‚úÖ</span> –ü—Ä–∏–≤—ã—á–∫–∏</button>
                <button class="nav-item" onclick="showPage('tasks')"><span class="icon">üìã</span> –ó–∞–¥–∞—á–∏</button>
                <button class="nav-item" onclick="showPage('goals')"><span class="icon">üéØ</span> –¶–µ–ª–∏</button>
                <button class="nav-item" onclick="showPage('focus')"><span class="icon">‚è±Ô∏è</span> –§–æ–∫—É—Å</button>
                <button class="nav-item" onclick="showPage('sleep')"><span class="icon">üò¥</span> –°–æ–Ω</button>
                <button class="nav-item" onclick="showPage('analytics')"><span class="icon">üìä</span> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                <button class="nav-item" onclick="showPage('journal')"><span class="icon">üìù</span> –ñ—É—Ä–Ω–∞–ª</button>
                <button class="nav-item" onclick="showPage('profile')"><span class="icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-xp"><div class="sidebar-xp-value" id="sideXP">0 XP</div><div class="sidebar-xp-label" id="sideLevel">–£—Ä–æ–≤–µ–Ω—å 1</div></div>
                <button class="logout-btn" onclick="signOut()">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </aside>

        <header class="mobile-header">
            <div class="mobile-logo">üöÄ Productivity</div>
            <div class="mobile-header-right">
                <div class="xp-badge" id="mobileXP">0 XP</div>
                <img class="mobile-avatar" id="mobilePhoto" src="" onclick="showPage('profile')">
            </div>
        </header>

        <main class="main-content">
            <!-- HOME -->
            <div id="p-home" class="page active">
                <div class="weather-widget" id="weatherWidget">
                    <div class="weather-main">
                        <div><div class="weather-temp" id="weatherTemp">--¬∞</div><div class="weather-location" id="weatherLocation">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
                        <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail"><span>üíß</span><span id="weatherHumidity">--%</span></div>
                        <div class="weather-detail"><span>üí®</span><span id="weatherWind">-- –º/—Å</span></div>
                    </div>
                    <div class="weather-tip" id="weatherTip">–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!</div>
                </div>

                <div class="card level-card">
                    <div class="level-header"><span class="level-badge">‚ö° –£—Ä–æ–≤–µ–Ω—å <span id="lvlNum">1</span></span><span class="level-xp"><span id="xpNow">0</span>/<span id="xpNeed">100</span></span></div>
                    <div class="progress-bar"><div class="progress-fill" id="lvlBar" style="width:0%"></div></div>
                    <div class="level-rank" id="rankText">üå± –ù–æ–≤–∏—á–æ–∫</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üî•</div><div class="stat-value" id="sStreak">0</div><div class="stat-label">–°—Ç—Ä–∏–∫</div></div>
                    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="sTotal">0</div><div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>
                    <div class="stat-card"><div class="stat-icon">üò¥</div><div class="stat-value" id="sSleep">--</div><div class="stat-label">–°–æ–Ω</div></div>
                    <div class="stat-card"><div class="stat-icon">üçÖ</div><div class="stat-value" id="sPomo">0</div><div class="stat-label">–§–æ–∫—É—Å</div></div>
                </div>

                <div class="card">
                    <div class="card-title">üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                    <div class="mood-selector">
                        <button class="mood-btn" onclick="setMood('üò¢')">üò¢</button>
                        <button class="mood-btn" onclick="setMood('üòï')">üòï</button>
                        <button class="mood-btn" onclick="setMood('üòê')">üòê</button>
                        <button class="mood-btn" onclick="setMood('üôÇ')">üôÇ</button>
                        <button class="mood-btn" onclick="setMood('üòÑ')">üòÑ</button>
                    </div>
                    <div class="mood-history" id="moodHist"></div>
                </div>

                <div class="card quote-card" onclick="newQuote()">
                    <div class="quote-text" id="qText">"–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º."</div>
                    <div class="quote-author" id="qAuthor">‚Äî Productivity Pro</div>
                </div>

                <div class="card"><div class="card-title">üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><div class="heatmap" id="heatmap"></div></div>
            </div>

            <!-- HABITS -->
            <div id="p-habits" class="page">
                <div class="card">
                    <div class="card-header"><div class="card-title">‚úÖ –ü—Ä–∏–≤—ã—á–∫–∏</div><button class="btn btn-sm btn-primary" onclick="openModal('habitModal')">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
                    <div id="habitsList"></div>
                </div>
                <div class="card">
                    <div class="card-title">üíß –í–æ–¥–∞</div>
                    <div class="water-display">
                        <div class="water-count"><span id="waterCount">0</span>/8</div>
                        <div class="water-glasses" id="waterGlasses"></div>
                        <div style="display:flex;gap:10px;justify-content:center;">
                            <button class="btn btn-sm btn-secondary" onclick="addWater(-1)">‚àí</button>
                            <button class="btn btn-sm btn-primary" onclick="addWater(1)">+ –°—Ç–∞–∫–∞–Ω</button>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-title">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</div><div class="chart-container"><canvas id="habitsChart"></canvas></div></div>
            </div>

            <!-- TASKS - IMPROVED -->
            <div id="p-tasks" class="page">
                <div class="tabs">
                    <button class="tab active" onclick="setTaskView('day')">üìÖ –î–µ–Ω—å</button>
                    <button class="tab" onclick="setTaskView('week')">üìÜ –ù–µ–¥–µ–ª—è</button>
                    <button class="tab" onclick="setTaskView('month')">üóìÔ∏è –ú–µ—Å—è—Ü</button>
                    <button class="tab" onclick="setTaskView('year')">üìä –ì–æ–¥</button>
                </div>

                <!-- Date Navigation -->
                <div class="date-nav">
                    <button class="date-nav-btn" onclick="navigateDate(-1)">‚óÄ</button>
                    <div class="date-nav-current">
                        <div class="date-nav-title" id="dateNavTitle">–°–µ–≥–æ–¥–Ω—è</div>
                        <div class="date-nav-subtitle" id="dateNavSubtitle">1 —è–Ω–≤–∞—Ä—è 2025</div>
                    </div>
                    <button class="date-nav-btn" onclick="navigateDate(1)">‚ñ∂</button>
                    <button class="date-nav-today" onclick="goToToday()">–°–µ–≥–æ–¥–Ω—è</button>
                </div>

                <!-- Quick Dates (for day view) -->
                <div class="quick-dates" id="quickDates"></div>

                <!-- Calendar (for month view) -->
                <div class="card" id="calendarCard" style="display:none;">
                    <div class="calendar-mini" id="calendarMini"></div>
                </div>

                <!-- Tags Filter -->
                <div class="card">
                    <div class="card-header"><div class="card-title">üè∑Ô∏è –§–∏–ª—å—Ç—Ä</div><button class="btn btn-sm btn-secondary" onclick="openModal('tagModal')">+ –¢–µ–≥</button></div>
                    <div class="tags-container" id="tagFilter"></div>
                </div>

                <!-- Tasks List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title" id="tasksListTitle">üìã –ó–∞–¥–∞—á–∏</div>
                        <button class="btn btn-sm btn-primary" onclick="openTaskModal()">+ –ó–∞–¥–∞—á–∞</button>
                    </div>
                    <div id="tasksList"></div>
                </div>

                <button class="fab" onclick="openTaskModal()">+</button>
            </div>

            <!-- GOALS -->
            <div id="p-goals" class="page">
                <div class="card">
                    <div class="card-header"><div class="card-title">üéØ –¶–µ–ª–∏</div><button class="btn btn-sm btn-primary" onclick="openModal('goalModal')">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
                    <div id="goalsList"></div>
                </div>
                <div class="card"><div class="card-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div><div class="achieve-grid" id="achieveGrid"></div></div>
            </div>

            <!-- FOCUS -->
            <div id="p-focus" class="page">
                <div class="card">
                    <div class="focus-widget">
                        <div class="focus-timer" id="focusTime">25:00</div>
                        <div class="focus-status" id="focusStatus">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                        <div class="focus-btns">
                            <button class="btn btn-primary" id="focusBtn" onclick="toggleFocus()">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                            <button class="btn btn-secondary" onclick="resetFocus()">‚Ü∫ –°–±—Ä–æ—Å</button>
                        </div>
                    </div>
                </div>
                <div class="stats-grid" style="grid-template-columns:repeat(2,1fr);">
                    <div class="stat-card"><div class="stat-icon">üçÖ</div><div class="stat-value" id="focusToday">0</div><div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div></div>
                    <div class="stat-card"><div class="stat-icon">üèÜ</div><div class="stat-value" id="focusTotal">0</div><div class="stat-label">–í—Å–µ–≥–æ</div></div>
                </div>
                <div class="card"><div class="card-title">üìä –§–æ–∫—É—Å –∑–∞ –Ω–µ–¥–µ–ª—é</div><div class="chart-container"><canvas id="focusChart"></canvas></div></div>
            </div>

            <!-- SLEEP -->
            <div id="p-sleep" class="page">
                <div class="card">
                    <div class="card-title">üò¥ –°–æ–Ω —Å–µ–≥–æ–¥–Ω—è</div>
                    <div class="sleep-widget">
                        <div class="sleep-display"><span class="sleep-hours" id="sleepHours">7</span><span class="sleep-unit">—á–∞—Å–æ–≤</span></div>
                        <input type="range" class="sleep-slider" id="sleepSlider" min="0" max="12" step="0.5" value="7" oninput="updateSleepDisplay()">
                        <div class="sleep-quality">
                            <button class="quality-btn" onclick="setSleepQuality('üò´')">üò´</button>
                            <button class="quality-btn" onclick="setSleepQuality('üò¥')">üò¥</button>
                            <button class="quality-btn" onclick="setSleepQuality('üòä')">üòä</button>
                            <button class="quality-btn" onclick="setSleepQuality('ü§©')">ü§©</button>
                        </div>
                        <button class="btn btn-primary" onclick="saveSleep()" style="margin-top:20px;width:100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="card"><div class="card-title">üìä –°–æ–Ω –∑–∞ –Ω–µ–¥–µ–ª—é</div><div class="chart-container tall"><canvas id="sleepChart"></canvas></div></div>
            </div>

            <!-- ANALYTICS -->
            <div id="p-analytics" class="page">
                <div class="card"><div class="card-title">üìà –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><div class="chart-container tall"><canvas id="weeklyChart"></canvas></div></div>
                <div class="card"><div class="card-title">üéØ –ü—Ä–∏–≤—ã—á–∫–∏</div><div class="chart-container"><canvas id="habitsPieChart"></canvas></div></div>
                <div class="card"><div class="card-title">üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div><div class="chart-container"><canvas id="moodChart"></canvas></div></div>
            </div>

            <!-- JOURNAL -->
            <div id="p-journal" class="page">
                <div class="card">
                    <div class="card-title">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
                    <textarea class="textarea" id="journalInput" placeholder="–ß—Ç–æ –Ω–∞ —É–º–µ?"></textarea>
                    <button class="btn btn-primary" onclick="addJournal()" style="margin-top:12px;width:100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <div id="journalList"></div>
            </div>

            <!-- PROFILE -->
            <div id="p-profile" class="page">
                <div class="card profile-header">
                    <div class="profile-avatar" id="pAvatar"></div>
                    <div style="font-size:1.3rem;font-weight:600;" id="pName">User</div>
                    <div style="color:var(--text-muted);margin-top:4px;" id="pEmail">email</div>
                    <div style="color:var(--warning);margin-top:8px;">–£—Ä–æ–≤–µ–Ω—å <span id="pLevel">1</span></div>
                </div>
                <div class="card">
                    <div class="card-title">üé® –¢–µ–º–∞</div>
                    <div class="theme-grid">
                        <div class="theme-option t-dark selected" onclick="setTheme('')">üåô –¢—ë–º–Ω–∞—è</div>
                        <div class="theme-option t-light" onclick="setTheme('theme-light')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</div>
                        <div class="theme-option t-ocean" onclick="setTheme('theme-ocean')">üåä –û–∫–µ–∞–Ω</div>
                        <div class="theme-option t-forest" onclick="setTheme('theme-forest')">üå≤ –õ–µ—Å</div>
                        <div class="theme-option t-sunset" onclick="setTheme('theme-sunset')">üåÖ –ó–∞–∫–∞—Ç</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <button class="btn btn-secondary" onclick="requestNotifications()" style="width:100%;">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                </div>
                <div class="card">
                    <div class="card-title">üíæ –î–∞–Ω–Ω—ã–µ</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="btn btn-danger btn-sm" onclick="resetData()">üóëÔ∏è –°–±—Ä–æ—Å</button>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="signOut()" style="width:100%;">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </main>
    </div>

    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <button class="bottom-nav-item active" onclick="showPage('home')"><span class="icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="bottom-nav-item" onclick="showPage('habits')"><span class="icon">‚úÖ</span><span>–ü—Ä–∏–≤—ã—á–∫–∏</span></button>
        <button class="bottom-nav-item" onclick="showPage('tasks')"><span class="icon">üìã</span><span>–ó–∞–¥–∞—á–∏</span></button>
        <button class="bottom-nav-item" onclick="showPage('sleep')"><span class="icon">üò¥</span><span>–°–æ–Ω</span></button>
        <button class="bottom-nav-item" onclick="showPage('profile')"><span class="icon">‚öôÔ∏è</span><span>–ï—â—ë</span></button>
    </nav>

    <!-- Modals -->
    <div class="modal-overlay" id="habitModal"><div class="modal"><div class="modal-handle"></div><h3>‚úÖ –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</h3><div class="input-group"><label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="input" id="habitName" placeholder="üèÉ –ü—Ä–æ–±–µ–∂–∫–∞"></div><div class="modal-btns"><button class="btn btn-secondary" onclick="closeModal('habitModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="addHabit()">–î–æ–±–∞–≤–∏—Ç—å</button></div></div></div>

    <div class="modal-overlay" id="taskModal"><div class="modal"><div class="modal-handle"></div><h3>üìã –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
        <div class="input-group"><label class="input-label">–ó–∞–¥–∞—á–∞</label><input type="text" class="input" id="taskName" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?"></div>
        <div class="input-group"><label class="input-label">–î–∞—Ç–∞</label><input type="date" class="input" id="taskDate"></div>
        <div class="input-group"><label class="input-label">–¢–∏–ø –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</label>
            <select class="input" id="taskType">
                <option value="day">–ù–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å</option>
                <option value="month">–¶–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü</option>
                <option value="year">–¶–µ–ª—å –Ω–∞ –≥–æ–¥</option>
            </select>
        </div>
        <div class="input-group"><label class="input-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select class="input" id="taskPriority">
                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
            </select>
        </div>
        <div class="input-group"><label class="input-label">üè∑Ô∏è –¢–µ–≥–∏</label><div class="tags-container" id="taskTagsSelect"></div></div>
        <div class="modal-btns"><button class="btn btn-secondary" onclick="closeModal('taskModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button></div>
    </div></div>

    <div class="modal-overlay" id="tagModal"><div class="modal"><div class="modal-handle"></div><h3>üè∑Ô∏è –ù–æ–≤—ã–π —Ç–µ–≥</h3><div class="input-group"><label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="input" id="tagName" placeholder="–†–∞–±–æ—Ç–∞"></div><div class="input-group"><label class="input-label">–¶–≤–µ—Ç</label><div class="tag-colors" id="tagColors"></div></div><div class="modal-btns"><button class="btn btn-secondary" onclick="closeModal('tagModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="addTag()">–°–æ–∑–¥–∞—Ç—å</button></div></div></div>

    <div class="modal-overlay" id="goalModal"><div class="modal"><div class="modal-handle"></div><h3>üéØ –ù–æ–≤–∞—è —Ü–µ–ª—å</h3><div class="input-group"><label class="input-label">–¶–µ–ª—å</label><input type="text" class="input" id="goalName" placeholder="–î–æ—Å—Ç–∏—á—å..."></div><div class="input-group"><label class="input-label">–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label><input type="number" class="input" id="goalTarget" value="100" min="1"></div><div class="modal-btns"><button class="btn btn-secondary" onclick="closeModal('goalModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="addGoal()">–°–æ–∑–¥–∞—Ç—å</button></div></div></div>

    <script>
        // Firebase
        const firebaseConfig={apiKey:"AIzaSyD3vjzA6gnRwyzhhcevtT3j1q11ViI-Tlk",authDomain:"my-productivity-a7f03.firebaseapp.com",databaseURL:"https://my-productivity-a7f03-default-rtdb.firebaseio.com",projectId:"my-productivity-a7f03",storageBucket:"my-productivity-a7f03.firebasestorage.app",messagingSenderId:"259649528488",appId:"1:259649528488:web:9cbd896103f9f0a6f4589d"};
        firebase.initializeApp(firebaseConfig);
        const auth=firebase.auth(),db=firebase.database();

        // Data
        let D={habits:[],habitHistory:{},tasks:[],tags:[],goals:[],journal:[],mood:{},water:{},sleep:{},focus:{total:0,today:0,lastDate:'',history:{}},xp:0,maxStreak:0,achievements:{},theme:'',lastUpdated:0};
        let currentUser=null,charts={};

        // Task Planning State
        let taskView='day'; // day, week, month, year
        let selectedDate=new Date();
        let selectedTags=[],filterTag=null,selectedTagColor='#6366f1',sleepQuality='üòä';
        let focusInterval=null,focusSecs=25*60,focusRunning=false,focusMode='work';

        const COLORS=['#6366f1','#8b5cf6','#ec4899','#ef4444','#f59e0b','#10b981','#06b6d4','#3b82f6'];
        const RANKS=[{l:1,t:'üå± –ù–æ–≤–∏—á–æ–∫'},{l:3,t:'üåø –£—á–µ–Ω–∏–∫'},{l:5,t:'üå≥ –ü—Ä–∞–∫—Ç–∏–∫'},{l:8,t:'‚öîÔ∏è –í–æ–∏–Ω'},{l:12,t:'üõ°Ô∏è –†—ã—Ü–∞—Ä—å'},{l:17,t:'üëë –ú–∞—Å—Ç–µ—Ä'}];
        const ACHIEVEMENTS=[{id:'first',i:'üéØ',n:'–ü–µ—Ä–≤—ã–π —à–∞–≥',c:()=>D.habits.length>=1},{id:'s7',i:'üî•',n:'7 –¥–Ω–µ–π',c:()=>D.maxStreak>=7},{id:'l5',i:'üöÄ',n:'–£—Ä–æ–≤–µ–Ω—å 5',c:()=>getLevel()>=5}];
        const QUOTES=[{t:"–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º.",a:"Productivity Pro"},{t:"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî –º–æ—Å—Ç –º–µ–∂–¥—É —Ü–µ–ª—è–º–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏.",a:"–î–∂. –†–æ–Ω"}];
        const DAYS=['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
        const MONTHS=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

        const $=id=>document.getElementById(id);
        const formatDate=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const today=()=>formatDate(new Date());
        const parseDate=s=>{const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d);};

        // Auth
        function signInWithGoogle(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert('–û—à–∏–±–∫–∞: '+e.message));}
        function signOut(){if(confirm('–í—ã–π—Ç–∏?'))auth.signOut();}

        auth.onAuthStateChanged(user=>{
            $('loading').style.display='none';
            if(user){currentUser=user;$('authScreen').style.display='none';$('app').style.display='flex';$('bottomNav').style.display='flex';updateUserUI(user);loadFromCloud();}
            else{$('authScreen').style.display='flex';$('app').style.display='none';$('bottomNav').style.display='none';}
        });

        function updateUserUI(u){
            const photo=u.photoURL||'',name=u.displayName||'User';
            $('sidePhoto').src=photo;$('sideName').textContent=name;$('sideEmail').textContent=u.email;
            $('mobilePhoto').src=photo;$('pAvatar').innerHTML=photo?`<img src="${photo}">`:'üòé';
            $('pName').textContent=name;$('pEmail').textContent=u.email;
        }

        function loadFromCloud(){
            db.ref('users/'+currentUser.uid).once('value').then(snap=>{
                const data=snap.val();
                if(data)D={...D,...data};
                else{D.habits=[{id:1,name:'üèÉ –°–ø–æ—Ä—Ç'},{id:2,name:'üìö –ß—Ç–µ–Ω–∏–µ'}];D.tags=[{id:1,name:'–†–∞–±–æ—Ç–∞',color:'#6366f1'}];D.tasks=[];}
                if(!Array.isArray(D.tasks))D.tasks=[];
                applyTheme();updateAll();getWeather();
            });
            db.ref('users/'+currentUser.uid).on('value',snap=>{const data=snap.val();if(data&&data.lastUpdated>D.lastUpdated){D={...D,...data};if(!Array.isArray(D.tasks))D.tasks=[];updateAll();}});
        }

        function save(){D.lastUpdated=Date.now();if(currentUser)db.ref('users/'+currentUser.uid).set(D);}

        // Weather
        async function getWeather(){
            try{
                const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:5000}));
                const{latitude:lat,longitude:lon}=pos.coords;
                const resp=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
                const data=await resp.json(),c=data.current;
                $('weatherTemp').textContent=Math.round(c.temperature_2m)+'¬∞';
                $('weatherHumidity').textContent=c.relative_humidity_2m+'%';
                $('weatherWind').textContent=Math.round(c.wind_speed_10m)+' –º/—Å';
                const icons={0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',51:'üåßÔ∏è',61:'üåßÔ∏è',71:'‚ùÑÔ∏è',95:'‚õàÔ∏è'};
                $('weatherIcon').textContent=icons[c.weather_code]||'üå§Ô∏è';
                $('weatherTip').textContent=c.temperature_2m>20?'–û—Ç–ª–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏!':c.temperature_2m<5?'–•–æ–ª–æ–¥–Ω–æ ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –¥–æ–º–∞':'–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
            }catch(e){$('weatherLocation').textContent='–ü–æ–≥–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';}
        }

        // Pages
        function showPage(name){
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            $('p-'+name)?.classList.add('active');
            document.querySelectorAll('.nav-item,.bottom-nav-item').forEach(n=>n.classList.remove('active'));
            event?.target?.closest('.nav-item,.bottom-nav-item')?.classList.add('active');
            if(name==='analytics')renderCharts();if(name==='sleep')renderSleepChart();if(name==='tasks')renderTasksPage();
        }

        function updateAll(){
            updateUI();renderHabits();renderWater();renderMood();renderHeatmap();
            renderTasksPage();renderGoals();renderAchievements();renderJournal();
            renderTagFilter();renderTagColors();updateFocusDisplay();
        }

        function updateUI(){
            $('mobileXP').textContent=D.xp+' XP';$('sideXP').textContent=D.xp+' XP';
            $('sideLevel').textContent=`–£—Ä–æ–≤–µ–Ω—å ${getLevel()}`;$('lvlNum').textContent=getLevel();
            const info=getXPInfo();$('xpNow').textContent=info.cur;$('xpNeed').textContent=info.need;
            $('lvlBar').style.width=(info.cur/info.need*100)+'%';$('rankText').textContent=getRank();
            $('sStreak').textContent=getStreak();$('sTotal').textContent=getTotalDone();
            $('sSleep').textContent=D.sleep[today()]?.hours?D.sleep[today()].hours+'—á':'--';
            $('sPomo').textContent=D.focus.today;$('pLevel').textContent=getLevel();
            D.maxStreak=Math.max(D.maxStreak,getStreak());
        }

        function getLevel(){let l=1,n=100,x=D.xp;while(x>=n){x-=n;l++;n=Math.floor(n*1.4);}return l;}
        function getXPInfo(){let l=1,n=100,x=D.xp;while(x>=n){x-=n;l++;n=Math.floor(n*1.4);}return{cur:x,need:n};}
        function getRank(){const l=getLevel();let r=RANKS[0].t;RANKS.forEach(x=>{if(l>=x.l)r=x.t;});return r;}
        function addXP(n){D.xp+=n;celebrate('‚ú®');save();updateUI();checkAchievements();}
        function getStreak(){let s=0,d=new Date();if(!D.habitHistory[today()]||!Object.values(D.habitHistory[today()]).some(v=>v))d.setDate(d.getDate()-1);while(true){const ds=formatDate(d);if(D.habitHistory[ds]&&Object.values(D.habitHistory[ds]).some(v=>v)){s++;d.setDate(d.getDate()-1);}else break;}return s;}
        function getTotalDone(){let t=0;Object.values(D.habitHistory).forEach(day=>{t+=Object.values(day).filter(v=>v).length;});return t;}

        // Habits
        function renderHabits(){
            if(!D.habitHistory[today()])D.habitHistory[today()]={};
            $('habitsList').innerHTML=D.habits.length?D.habits.map(h=>{
                const done=D.habitHistory[today()][h.id]||false,pct=getHabitPct(h.id);
                return`<div class="habit-item ${done?'done':''}"><div class="habit-check ${done?'checked':''}" onclick="toggleHabit(${h.id})"></div><div class="habit-info"><div class="habit-name">${h.name}</div><div class="habit-streak">üî• ${getHabitStreak(h.id)} –¥–Ω.</div></div><div class="habit-pct">${pct}%</div><button class="delete-btn" onclick="deleteHabit(${h.id})">√ó</button></div>`;
            }).join(''):'<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!</p></div>';
        }
        function toggleHabit(id){if(!D.habitHistory[today()])D.habitHistory[today()]={};const was=D.habitHistory[today()][id];D.habitHistory[today()][id]=!was;if(!was)addXP(10);else D.xp=Math.max(0,D.xp-10);save();updateAll();}
        function addHabit(){const n=$('habitName').value.trim();if(n){D.habits.push({id:Date.now(),name:n});save();closeModal('habitModal');$('habitName').value='';updateAll();celebrate('üéØ');}}
        function deleteHabit(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?')){D.habits=D.habits.filter(h=>h.id!==id);save();renderHabits();}}
        function getHabitStreak(id){let s=0,d=new Date();if(!D.habitHistory[today()]?.[id])d.setDate(d.getDate()-1);while(D.habitHistory[formatDate(d)]?.[id]){s++;d.setDate(d.getDate()-1);}return s;}
        function getHabitPct(id){let done=0,total=0;Object.values(D.habitHistory).forEach(day=>{if(day[id]!==undefined){total++;if(day[id])done++;}});return total?Math.round(done/total*100):0;}

        // Water
        function renderWater(){const c=D.water[today()]||0;$('waterCount').textContent=c;$('waterGlasses').innerHTML=Array(8).fill(0).map((_,i)=>`<div class="water-glass ${i<c?'filled':''}" onclick="setWater(${i+1})"></div>`).join('');}
        function addWater(n){D.water[today()]=Math.max(0,Math.min(8,(D.water[today()]||0)+n));if(n>0)addXP(2);save();renderWater();updateUI();}
        function setWater(n){D.water[today()]=n;save();renderWater();updateUI();}

        // ===== IMPROVED TASK SYSTEM =====
        function setTaskView(view){
            taskView=view;
            document.querySelectorAll('#p-tasks .tab').forEach(t=>t.classList.remove('active'));
            event.target.classList.add('active');
            selectedDate=new Date();
            renderTasksPage();
        }

        function navigateDate(dir){
            if(taskView==='day')selectedDate.setDate(selectedDate.getDate()+dir);
            else if(taskView==='week')selectedDate.setDate(selectedDate.getDate()+dir*7);
            else if(taskView==='month')selectedDate.setMonth(selectedDate.getMonth()+dir);
            else if(taskView==='year')selectedDate.setFullYear(selectedDate.getFullYear()+dir);
            renderTasksPage();
        }

        function goToToday(){selectedDate=new Date();renderTasksPage();}

        function selectDate(dateStr){selectedDate=parseDate(dateStr);renderTasksPage();}

        function renderTasksPage(){
            renderDateNav();
            renderQuickDates();
            renderCalendar();
            renderTasksList();
        }

        function renderDateNav(){
            let title='',subtitle='';
            const d=selectedDate,isToday=formatDate(d)===today();
            
            if(taskView==='day'){
                title=isToday?'–°–µ–≥–æ–¥–Ω—è':formatDate(d)===formatDate(new Date(Date.now()+86400000))?'–ó–∞–≤—Ç—Ä–∞':formatDate(d)===formatDate(new Date(Date.now()-86400000))?'–í—á–µ—Ä–∞':DAYS[d.getDay()];
                subtitle=`${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
            }else if(taskView==='week'){
                const weekStart=new Date(d);weekStart.setDate(d.getDate()-d.getDay()+1);
                const weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+6);
                title='–ù–µ–¥–µ–ª—è';
                subtitle=`${weekStart.getDate()} ${MONTHS[weekStart.getMonth()].slice(0,3)} - ${weekEnd.getDate()} ${MONTHS[weekEnd.getMonth()].slice(0,3)}`;
            }else if(taskView==='month'){
                title=MONTHS[d.getMonth()];
                subtitle=d.getFullYear().toString();
            }else{
                title=d.getFullYear().toString();
                subtitle='–ì–æ–¥–æ–≤—ã–µ —Ü–µ–ª–∏';
            }
            
            $('dateNavTitle').textContent=title;
            $('dateNavSubtitle').textContent=subtitle;
        }

        function renderQuickDates(){
            if(taskView!=='day'){$('quickDates').innerHTML='';return;}
            
            let html='';
            for(let i=-2;i<=7;i++){
                const d=new Date();d.setDate(d.getDate()+i);
                const ds=formatDate(d),isActive=ds===formatDate(selectedDate);
                let label=d.getDate().toString();
                if(i===0)label='–°–µ–≥–æ–¥–Ω—è';else if(i===1)label='–ó–∞–≤—Ç—Ä–∞';else if(i===-1)label='–í—á–µ—Ä–∞';
                html+=`<button class="quick-date-btn ${isActive?'active':''}" onclick="selectDate('${ds}')">${label}<br><small>${DAYS[d.getDay()]}</small></button>`;
            }
            $('quickDates').innerHTML=html;
        }

        function renderCalendar(){
            if(taskView!=='month'){$('calendarCard').style.display='none';return;}
            $('calendarCard').style.display='block';
            
            const d=selectedDate,year=d.getFullYear(),month=d.getMonth();
            const firstDay=new Date(year,month,1),lastDay=new Date(year,month+1,0);
            const startDay=(firstDay.getDay()+6)%7;
            
            let html='';
            ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(day=>{html+=`<div class="calendar-day-header">${day}</div>`;});
            
            // Previous month days
            const prevMonth=new Date(year,month,0);
            for(let i=startDay-1;i>=0;i--){
                const day=prevMonth.getDate()-i;
                html+=`<div class="calendar-day other-month">${day}</div>`;
            }
            
            // Current month days
            for(let day=1;day<=lastDay.getDate();day++){
                const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const isToday=ds===today();
                const isSelected=ds===formatDate(selectedDate);
                const hasTasks=D.tasks.some(t=>t.date===ds&&!t.done);
                html+=`<div class="calendar-day ${isToday?'today':''} ${isSelected?'selected':''} ${hasTasks?'has-tasks':''}" onclick="selectDate('${ds}')">${day}</div>`;
            }
            
            // Next month days
            const remaining=42-(startDay+lastDay.getDate());
            for(let day=1;day<=remaining&&remaining<7;day++){
                html+=`<div class="calendar-day other-month">${day}</div>`;
            }
            
            $('calendarMini').innerHTML=html;
        }

        function getTasksForView(){
            const d=selectedDate;
            let tasks=D.tasks.filter(t=>{
                if(taskView==='day')return t.date===formatDate(d)&&t.type!=='month'&&t.type!=='year';
                if(taskView==='week'){
                    const taskDate=parseDate(t.date);
                    const weekStart=new Date(d);weekStart.setDate(d.getDate()-d.getDay()+1);
                    const weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+6);
                    return taskDate>=weekStart&&taskDate<=weekEnd&&t.type!=='month'&&t.type!=='year';
                }
                if(taskView==='month'){
                    const taskDate=parseDate(t.date);
                    return(taskDate.getMonth()===d.getMonth()&&taskDate.getFullYear()===d.getFullYear())||t.type==='month';
                }
                if(taskView==='year'){
                    return t.type==='year'||parseDate(t.date).getFullYear()===d.getFullYear();
                }
                return false;
            });
            
            if(filterTag)tasks=tasks.filter(t=>t.tags?.includes(filterTag));
            return tasks.sort((a,b)=>{
                if(a.done!==b.done)return a.done?1:-1;
                const priorityOrder={high:0,medium:1,low:2};
                return priorityOrder[a.priority]-priorityOrder[b.priority];
            });
        }

        function renderTasksList(){
            const tasks=getTasksForView();
            const titles={day:'üìã –ó–∞–¥–∞—á–∏ –Ω–∞ –¥–µ–Ω—å',week:'üìã –ó–∞–¥–∞—á–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é',month:'üìã –¶–µ–ª–∏ –Ω–∞ –º–µ—Å—è—Ü',year:'üìã –¶–µ–ª–∏ –Ω–∞ –≥–æ–¥'};
            $('tasksListTitle').textContent=titles[taskView];
            
            if(!tasks.length){
                $('tasksList').innerHTML=`<div class="empty-state"><div class="empty-state-icon">üìã</div><p>–ù–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é!</p></div>`;
                return;
            }
            
            $('tasksList').innerHTML=tasks.map(t=>`
                <div class="task-item ${t.done?'done':''}">
                    <div class="task-check ${t.done?'checked':''}" onclick="toggleTask(${t.id})"></div>
                    <div class="task-content">
                        <div class="task-text">${t.text}</div>
                        <div class="task-meta">
                            <span class="task-date">${taskView==='week'?DAYS[parseDate(t.date).getDay()]+', ':''} ${parseDate(t.date).getDate()} ${MONTHS[parseDate(t.date).getMonth()].slice(0,3)}</span>
                            <div class="task-tags">${(t.tags||[]).map(tid=>{const tag=D.tags.find(x=>x.id===tid);return tag?`<span class="tag" style="background:${tag.color}">${tag.name}</span>`:''}).join('')}</div>
                        </div>
                    </div>
                    <div class="priority-dot priority-${t.priority}"></div>
                    <button class="delete-btn" onclick="deleteTask(${t.id})">√ó</button>
                </div>
            `).join('');
        }

        function openTaskModal(){
            $('taskDate').value=formatDate(selectedDate);
            $('taskType').value=taskView==='year'?'year':taskView==='month'?'month':'day';
            selectedTags=[];
            renderTaskTagsSelect();
            openModal('taskModal');
        }

        function addTask(){
            const text=$('taskName').value.trim();
            const date=$('taskDate').value||formatDate(selectedDate);
            const type=$('taskType').value;
            const priority=$('taskPriority').value;
            
            if(text){
                D.tasks.push({id:Date.now(),text,date,type,priority,tags:[...selectedTags],done:false,createdAt:new Date().toISOString()});
                save();
                closeModal('taskModal');
                $('taskName').value='';
                selectedTags=[];
                renderTasksPage();
                celebrate('üìã');
            }
        }

        function toggleTask(id){
            const t=D.tasks.find(x=>x.id===id);
            if(t){t.done=!t.done;if(t.done)addXP(5);save();renderTasksPage();}
        }

        function deleteTask(id){
            D.tasks=D.tasks.filter(x=>x.id!==id);
            save();
            renderTasksPage();
        }

        // Tags
        function renderTagFilter(){
            $('tagFilter').innerHTML=`<button class="tag-btn ${filterTag===null?'selected':''}" style="background:var(--bg-tertiary)" onclick="setFilterTag(null)">–í—Å–µ</button>`+D.tags.map(t=>`<button class="tag-btn ${filterTag===t.id?'selected':''}" style="background:${t.color}" onclick="setFilterTag(${t.id})">${t.name}</button>`).join('');
        }
        function setFilterTag(id){filterTag=id;renderTagFilter();renderTasksPage();}
        function renderTaskTagsSelect(){$('taskTagsSelect').innerHTML=D.tags.map(t=>`<button type="button" class="tag-btn ${selectedTags.includes(t.id)?'selected':''}" style="background:${t.color}" onclick="toggleTaskTag(${t.id})">${t.name}</button>`).join('');}
        function toggleTaskTag(id){if(selectedTags.includes(id))selectedTags=selectedTags.filter(x=>x!==id);else selectedTags.push(id);renderTaskTagsSelect();}
        function renderTagColors(){$('tagColors').innerHTML=COLORS.map(c=>`<div class="color-btn ${selectedTagColor===c?'selected':''}" style="background:${c}" onclick="selectedTagColor='${c}';renderTagColors();"></div>`).join('');}
        function addTag(){const n=$('tagName').value.trim();if(n){D.tags.push({id:Date.now(),name:n,color:selectedTagColor});save();closeModal('tagModal');$('tagName').value='';renderTagFilter();}}

        // Goals
        function addGoal(){const n=$('goalName').value.trim(),t=parseInt($('goalTarget').value)||100;if(n){D.goals.push({id:Date.now(),name:n,target:t,current:0});save();closeModal('goalModal');$('goalName').value='';renderGoals();celebrate('üéØ');}}
        function updateGoal(id,d){const g=D.goals.find(x=>x.id===id);if(g){g.current=Math.max(0,Math.min(g.target,g.current+d));if(g.current===g.target)celebrate('üèÜ');save();renderGoals();}}
        function deleteGoal(id){D.goals=D.goals.filter(x=>x.id!==id);save();renderGoals();}
        function renderGoals(){$('goalsList').innerHTML=D.goals.length?D.goals.map(g=>{const p=Math.round(g.current/g.target*100);return`<div class="goal-item"><div class="goal-header"><div class="goal-title">${g.name}</div></div><div class="goal-bar"><div class="goal-fill" style="width:${p}%"></div></div><div class="goal-footer"><div class="goal-pct">${g.current}/${g.target}</div><div class="goal-btns"><button class="btn btn-sm btn-secondary" onclick="updateGoal(${g.id},-1)">‚àí</button><button class="btn btn-sm btn-primary" onclick="updateGoal(${g.id},1)">+</button><button class="btn btn-sm btn-danger" onclick="deleteGoal(${g.id})">√ó</button></div></div></div>`;}).join(''):'<div class="empty-state"><div class="empty-state-icon">üéØ</div><p>–î–æ–±–∞–≤—å —Ü–µ–ª—å!</p></div>';}

        // Focus
        function updateFocusDisplay(){const m=Math.floor(focusSecs/60),s=focusSecs%60;$('focusTime').textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;if(D.focus.lastDate!==today()){D.focus.today=0;D.focus.lastDate=today();}$('focusToday').textContent=D.focus.today;$('focusTotal').textContent=D.focus.total;}
        function toggleFocus(){if(focusRunning){clearInterval(focusInterval);focusRunning=false;$('focusBtn').textContent='‚ñ∂ –°—Ç–∞—Ä—Ç';}else{focusRunning=true;$('focusBtn').textContent='‚è∏ –ü–∞—É–∑–∞';focusInterval=setInterval(()=>{focusSecs--;updateFocusDisplay();if(focusSecs<=0){clearInterval(focusInterval);focusRunning=false;focusComplete();}},1000);}}
        function resetFocus(){clearInterval(focusInterval);focusRunning=false;focusMode='work';focusSecs=25*60;updateFocusDisplay();$('focusBtn').textContent='‚ñ∂ –°—Ç–∞—Ä—Ç';$('focusStatus').textContent='–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';}
        function focusComplete(){if(focusMode==='work'){D.focus.total++;D.focus.today++;if(!D.focus.history)D.focus.history={};if(!D.focus.history[today()])D.focus.history[today()]=0;D.focus.history[today()]++;addXP(25);celebrate('üçÖ');focusMode='break';focusSecs=5*60;$('focusStatus').textContent='‚òï –ü–µ—Ä–µ—Ä—ã–≤!';}else{focusMode='work';focusSecs=25*60;$('focusStatus').textContent='üí™ –†–∞–±–æ—Ç–∞–µ–º!';}save();updateFocusDisplay();updateUI();$('focusBtn').textContent='‚ñ∂ –°—Ç–∞—Ä—Ç';}

        // Sleep
        function updateSleepDisplay(){$('sleepHours').textContent=$('sleepSlider').value;}
        function setSleepQuality(q){sleepQuality=q;document.querySelectorAll('.quality-btn').forEach(b=>b.classList.toggle('selected',b.textContent===q));}
        function saveSleep(){D.sleep[today()]={hours:parseFloat($('sleepSlider').value),quality:sleepQuality};addXP(10);save();updateUI();celebrate('üò¥');renderSleepChart();}
        function renderSleepChart(){
            const ctx=$('sleepChart')?.getContext('2d');if(!ctx)return;
            const labels=[],values=[],colors=[];
            for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=formatDate(d);labels.push(DAYS[d.getDay()]);const s=D.sleep[ds];values.push(s?.hours||0);colors.push(s?.hours>=7?'#10b981':s?.hours>=5?'#f59e0b':'#ef4444');}
            if(charts.sleep)charts.sleep.destroy();
            charts.sleep=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data:values,backgroundColor:colors,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:12,ticks:{color:'#888'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#888'},grid:{display:false}}}}});
        }

        // Mood
        function setMood(e){D.mood[today()]=e;save();renderMood();celebrate(e);}
        function renderMood(){document.querySelectorAll('.mood-btn').forEach(b=>b.classList.toggle('selected',b.textContent===D.mood[today()]));const dates=Object.keys(D.mood).sort().slice(-7);$('moodHist').innerHTML=dates.map(d=>`<div class="mood-day"><div class="mood-day-emoji">${D.mood[d]}</div><div class="mood-day-date">${parseDate(d).getDate()} ${MONTHS[parseDate(d).getMonth()].slice(0,3)}</div></div>`).join('');}

        // Journal
        function addJournal(){const t=$('journalInput').value.trim();if(t){D.journal.unshift({id:Date.now(),date:new Date().toISOString(),text:t});save();$('journalInput').value='';renderJournal();addXP(5);}}
        function deleteJournal(id){D.journal=D.journal.filter(x=>x.id!==id);save();renderJournal();}
        function renderJournal(){$('journalList').innerHTML=D.journal.slice(0,20).map(e=>`<div class="card journal-entry"><div class="journal-date">${new Date(e.date).toLocaleString('ru-RU')}</div><div class="journal-text">${e.text}</div><button class="delete-btn" onclick="deleteJournal(${e.id})" style="float:right;margin-top:8px;">√ó</button></div>`).join('');}

        // Achievements
        function checkAchievements(){ACHIEVEMENTS.forEach(a=>{if(!D.achievements[a.id]&&a.c()){D.achievements[a.id]=true;celebrate('üèÜ');}});save();renderAchievements();}
        function renderAchievements(){$('achieveGrid').innerHTML=ACHIEVEMENTS.map(a=>`<div class="achieve-item ${D.achievements[a.id]?'unlocked':'locked'}"><div class="achieve-icon">${a.i}</div><div class="achieve-name">${a.n}</div></div>`).join('');}

        // Heatmap
        function renderHeatmap(){let html='';for(let i=59;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=formatDate(d);let l=0;if(D.habitHistory[ds]){const done=Object.values(D.habitHistory[ds]).filter(v=>v).length,total=D.habits.length||1,p=done/total;if(p>0)l=1;if(p>=0.5)l=2;if(p>=0.75)l=3;if(p>=1)l=4;}html+=`<div class="heat-day l${l}"></div>`;}$('heatmap').innerHTML=html;}

        // Charts
        function renderCharts(){
            const ctx1=$('weeklyChart')?.getContext('2d');if(ctx1){if(charts.weekly)charts.weekly.destroy();const labels=[],values=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);labels.push(DAYS[d.getDay()]);const ds=formatDate(d);values.push(D.habitHistory[ds]?Object.values(D.habitHistory[ds]).filter(v=>v).length:0);}charts.weekly=new Chart(ctx1,{type:'line',data:{labels,datasets:[{data:values,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.2)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#888'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#888'},grid:{display:false}}}}});}
            const ctx2=$('habitsPieChart')?.getContext('2d');if(ctx2){if(charts.pie)charts.pie.destroy();charts.pie=new Chart(ctx2,{type:'doughnut',data:{labels:D.habits.map(h=>h.name.slice(0,12)),datasets:[{data:D.habits.map(h=>getHabitPct(h.id)),backgroundColor:COLORS}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#888'}}}}});}
            const ctx3=$('moodChart')?.getContext('2d');if(ctx3){if(charts.mood)charts.mood.destroy();const moodNum={'üò¢':1,'üòï':2,'üòê':3,'üôÇ':4,'üòÑ':5},labels=[],values=[];for(let i=13;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=formatDate(d);labels.push(d.getDate());values.push(moodNum[D.mood[ds]]||null);}charts.mood=new Chart(ctx3,{type:'line',data:{labels,datasets:[{data:values,borderColor:'#ec4899',backgroundColor:'rgba(236,72,153,0.2)',fill:true,tension:0.4,spanGaps:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:1,max:5,ticks:{color:'#888'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#888'},grid:{display:false}}}}});}
            const ctx4=$('focusChart')?.getContext('2d');if(ctx4){if(charts.focus)charts.focus.destroy();const labels=[],values=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);labels.push(DAYS[d.getDay()]);const ds=formatDate(d);values.push(D.focus.history?.[ds]||0);}charts.focus=new Chart(ctx4,{type:'bar',data:{labels,datasets:[{data:values,backgroundColor:'#ef4444',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#888'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#888'},grid:{display:false}}}}});}
            const ctx5=$('habitsChart')?.getContext('2d');if(ctx5){if(charts.habits)charts.habits.destroy();charts.habits=new Chart(ctx5,{type:'bar',data:{labels:D.habits.map(h=>h.name.slice(0,10)),datasets:[{data:D.habits.map(h=>getHabitPct(h.id)),backgroundColor:COLORS,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100,ticks:{color:'#888'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#888'},grid:{display:false}}}}});}
        }

        // Theme
        function setTheme(t){D.theme=t;document.body.className=t;document.querySelectorAll('.theme-option').forEach(el=>el.classList.remove('selected'));event?.target?.classList.add('selected');save();}
        function applyTheme(){document.body.className=D.theme||'';}

        // Notifications
        function requestNotifications(){if('Notification'in window){Notification.requestPermission().then(p=>{if(p==='granted')alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!');});}}

        // Utils
        function newQuote(){const q=QUOTES[Math.floor(Math.random()*QUOTES.length)];$('qText').textContent=`"${q.t}"`;$('qAuthor').textContent=`‚Äî ${q.a}`;}
        function openModal(id){$(id).classList.add('active');}
        function closeModal(id){$(id).classList.remove('active');}
        document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active');});});
        function celebrate(emoji){const el=document.createElement('div');el.className='celebrate';el.textContent=emoji;document.body.appendChild(el);setTimeout(()=>el.remove(),800);}
        function exportData(){const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='productivity-backup.json';a.click();}
        function resetData(){if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')){D={habits:[],habitHistory:{},tasks:[],tags:[],goals:[],journal:[],mood:{},water:{},sleep:{},focus:{total:0,today:0,lastDate:'',history:{}},xp:0,maxStreak:0,achievements:{},theme:'',lastUpdated:0};save();location.reload();}}
    </script>
</body>
</html>
